(self.webpackChunk=self.webpackChunk||[]).push([[1317],{27929:(e,t,s)=>{s.r(t),s.d(t,{EmptyPushedContentServiceImpl:()=>j,G2PushedContentServiceImpl:()=>G,isLockedPushedContentItem:()=>w});var n=s(90023),i=s(35020),a=s(20108),o=s(68020),r=s(13391),c=s(77115),h=s(88012),d=s(74822),g=s(59179),u=s(90572),l=s(64271),p=s(31603),m=s(99887),_=s(24666),C=s(8794),f=s(36344),S=s(31851),b=s(48886),M=s(58303),v=s(2084),I=s(67177),P=s(61797),x=s(40594),k=s(31272),y=s(6824),T=s(36661),E=s(76572);const R=T.n(y.Schemable)(E.T0).is,O=T.n(y.Schemable)(E.D).is,U=T.n(y.Schemable)(E.JC).is;function w(e){return"lockedRewriteCard"===e.surface.kind||"lockedComment"===e.surface.kind}class G{constructor(e){this._params=e,this._logger=x.Y.create("G2PushedContentServiceImpl"),this._subs=new h.w.Keeper,this._disposed=new d.x,this._positionManager=new o.Xr,this._mapItemsToContentEntries=e=>Object.fromEntries(e.map((e=>[e.contentId,{notification:e.notification,surface:e.surface,contentId:e.contentId,originalPushedContentMessage:e}]))),this._updateContentState=e=>(0,n.zG)(e,i.$.createDiff,S.T.recover((e=>this._logger.error("conflicts on diff creating",e))),i.$.applyDiff,b.UI(S.T.recover((e=>this._logger.error("conflicts on diff apply",e)))),(e=>this.contentState.modify((t=>{const s=(0,n.zG)(t,Object.values,(e=>e.map((e=>e.originalPushedContentMessage))),i.$.from),a=e(s);return(0,n.zG)(a,i.$.values,this._mapItemsToContentEntries)})))),this.settingsState=r.h.create(M.YP),this.contentState=r.h.create({}),this._collectionState=this.contentState.view((0,n.ls)(Object.values,i.$.from));const t=this._params.capiStartAckMessage.pipe(g.U((0,n.ls)(M.UI((e=>{var t;return null===(t=e.serverConfigs)||void 0===t?void 0:t.PUSHED_CONTENT})),M.tS(M.ij))),u.h(M.pC),g.U(v.MH));this._pushedContentRangeManager=a.N.create(this._positionManager);const s=this._params.textObserver.getCurrentTextMap().getPlainText();this._positionManager.pushChanges(P.RI.resFromText(s)),this._subs.push(this._params.textObserver.contentChanges.async.subscribe((({deltaChange:e})=>{this._positionManager.pushChanges(e)}))),this._subs.push(this._pushedContentRangeManager.getDiff(this._collectionState).subscribe((({diffInput:e})=>{this._updateContentState(e)}))),this._subs.push(l.T([t,this._params.checkingService.pipe(u.h(M.pC),g.U((e=>e.value.capiMessages)),p.J(),u.h(O))]).pipe(p.J()).subscribe((e=>{this.settingsState.set(M.G(e))})),this._params.checkingService.pipe(u.h(M.pC),g.U((e=>e.value.capiMessages)),p.J(),u.h((0,c.Kg)(R,U))).subscribe(this._handlePushedContentMessage.bind(this)),this._listenForReconnect())}_listenForReconnect(){return this._params.capiStartAckMessage.pipe(m.oA,g.U((e=>e.sessionUuid)),_.x(),C.T(1)).subscribe((()=>{this._logger.info("Session started after disconnect, clearing pushed content items"),this.clear()}))}_handlePushedContentMessage(e){switch(e.action){case"pushed_content:pushedContent":let t=!0;if("vBar"===e.notification.notificationElement.kind){const s=e.notification.notificationElement.range,n=this._positionManager.findById(e.contentId);t=this._params.textRangeFilterForVBars({textRange:s,fullText:this._params.textObserver.getCurrentTextMap().getPlainText()}),M.pC(n)?n.value.start===s.start&&n.value.end===s.end||(this._positionManager.deregisterRange(e.contentId),t&&this._positionManager.registerRange(e.contentId,{start:s.start,end:s.end,meta:{id:e.contentId}})):t&&this._positionManager.registerRange(e.contentId,{start:s.start,end:s.end,meta:{id:e.contentId}})}t&&this.contentState.modify((t=>({...t,[e.contentId]:{notification:e.notification,surface:e.surface,contentId:e.contentId,originalPushedContentMessage:e}})));break;case"pushed_content:removeContent":try{this._positionManager.deregisterRange(e.contentId)}catch(t){this._logger.warn("Failed to deregister range for contentId",{contentId:e.contentId,error:String(t)})}this.contentState.modify((t=>Object.fromEntries(Object.entries(t).filter((([t])=>t!==e.contentId)))))}}_sendPushedContentMessage(e){return(0,n.zG)(this._params.checkingService.get(),I.Yo((()=>"Checking service not available.")),I.tS((t=>t.sendMessage(e.action,e,!1))))().then((()=>{})).catch((e=>{this._logger.error("Could not send Pushed Content message.",e)}))}dismiss(e){this._sendDismissContentMessage(e),this.removePushedContentItemLocally(e)}markResolved(e){this._sendDismissContentMessage(e),this.removePushedContentItemLocally(e)}clear(e){return this._logger.debug("Clearing pushed content items",{predicate:e}),e?this.contentState.modify((t=>Object.fromEntries(Object.entries(t).filter((([t,{originalPushedContentMessage:s}])=>!e(s)))))):this.contentState.set({})}rebaseItems(e,t){return f.E}getCollection(e,t){return r.h.combine(this._collectionState,null!=t?t:r.h.create(!0),((t,s)=>s?i.$.filter(e)(t):i.$.empty))}_sendDismissContentMessage(e){return this._sendPushedContentMessage({action:"pushed_content:dismissContent",contentId:e})}sendExecuteActionMessage(e,t,s){return this._sendPushedContentMessage({action:"pushed_content:executeAction",contentId:e,clientContext:t,request:s})}sendGetSettingsMessage(e){return this._sendPushedContentMessage({action:"pushed_content:getSettings",contentId:e})}sendUpdateSettingsMessage(e,t){return this._sendPushedContentMessage({action:"pushed_content:updateSettings",contentId:e,extraSettings:t.extraSettings,defaultAction:t.defaultAction,expandedTabs:t.expandedTabs})}removePushedContentItemLocally(e){this.contentState.modify((t=>(0,k.hX)((t=>t!==e),t)))}dispose(){this._subs.dispose(),this._disposed.next(void 0)}}class j{constructor(){this.settingsState=r.h.create(M.YP),this.contentState=r.h.create({})}dismiss(e){}markResolved(e){}clear(e){}rebaseItems(e,t){return f.E}getCollection(e,t){return r.h.create(i.$.empty)}sendExecuteActionMessage(){return Promise.resolve()}sendGetSettingsMessage(){return Promise.resolve()}sendUpdateSettingsMessage(){return Promise.resolve()}removePushedContentItemLocally(e){}unlock(e){}dispose(){}}}}]);