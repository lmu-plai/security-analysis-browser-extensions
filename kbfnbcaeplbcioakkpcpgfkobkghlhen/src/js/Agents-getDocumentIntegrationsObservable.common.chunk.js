(self.webpackChunk=self.webpackChunk||[]).push([[8616],{4621:(e,t,n)=>{n.r(t),n.d(t,{getDocumentIntegrationsObservable:()=>S});var s=n(50750),r=n(20161),i=n(84308),o=n(59179),c=n(90572),u=n(10883),a=n(84178),l=n(954),p=n(24666),d=n(8867),m=n(84714),h=n(36802),g=n(90189);class I{static loadContentScriptIntegrationSingleton(e){return null===this._contentScriptInstance&&(this._contentScriptInstance=Promise.all([n.e(308).then(n.bind(n,23541)),this._loadMessageBusClient(e.tabId)]).then((([{AgentsContentScriptIntegration:t},n])=>new t({tabId:e.tabId,messageBusClient:n})))),this._contentScriptInstance}static loadDocumentGroupIntegrationSingleton(e){return null===this._documentGroupInstance&&(this._documentGroupInstance=Promise.all([Promise.all([n.e(6790),n.e(9817),n.e(6358),n.e(9153)]).then(n.bind(n,45107)),this._loadMessageBusClient(e.tabId)]).then((([{AgentsDocumentGroupIntegration:t},n])=>new t({...e,messageBusClient:n})))),this._documentGroupInstance}static acquireReferenceFromDocument(e){this._documentReferences.add(e)}static releaseReferenceFromDocument(e){var t;this._documentReferences.delete(e),0===this._documentReferences.size&&(null===(t=this._documentGroupInstance)||void 0===t||t.then((e=>e[Symbol.asyncDispose]())),this._documentGroupInstance=null)}static _loadMessageBusClient(e){return null===this._contentScriptBusClient&&(this._contentScriptBusClient=Promise.all([n.e(6790),n.e(4943)]).then(n.bind(n,53128)).then((({DefaultAgentsMessageBusClient:t})=>new t({message:(0,g.OB)().browserApi.message,script:"cs",tabId:e})))),this._contentScriptBusClient}static dispose(){const e=[];return null!==this._contentScriptInstance&&(e.push(this._contentScriptInstance.then((e=>e[Symbol.dispose]()))),this._contentScriptInstance=null),null!==this._documentGroupInstance&&(e.push(this._documentGroupInstance.then((e=>e[Symbol.asyncDispose]()))),this._documentGroupInstance=null),null!==this._contentScriptBusClient&&(e.push(this._contentScriptBusClient.then((e=>e[Symbol.dispose]()))),this._contentScriptBusClient=null),this._documentReferences.clear(),Promise.all(e).then((()=>{}))}}function S(e){const t=(0,h.Of)(e.documentId),n=I.loadContentScriptIntegrationSingleton({tabId:e.tabId}),g=(0,s.D)(n).pipe((0,r.w)((e=>e.isActiveTab))),S=(0,s.D)(n).pipe((0,r.w)((e=>e.documentSessionDisposed))),b=(0,i.a)([g,e.isTextFieldFocused]).pipe((0,o.U)((([e,t])=>e&&t))),_=()=>I.loadDocumentGroupIntegrationSingleton({experimentClient:e.experimentClient,user:e.user,tabId:e.tabId,actions:e.actions}),C=S.pipe((0,c.h)((e=>e===t)),(0,u.M)(b),(0,c.h)((([e,t])=>!t)),(0,o.U)((()=>null))).pipe((0,r.w)((()=>b.pipe((0,c.h)(Boolean),(0,a.q)(1),(0,l.O)(!1)))),(0,l.O)(!0),(0,p.x)()),x=new d.y((n=>{const s=[];I.acquireReferenceFromDocument(t);const r=(0,i.a)([_(),e.textFieldSupportsAgents]).subscribe({next:([r,i])=>{try{s.push(r.runDocumentActivations({documentId:t,getPlainText:e.getPlainText,textChanges:e.textChanges,isTextFieldFocused:e.isTextFieldFocused,textFieldSupportsAgents:i,checkingService:e.checkingService,statisticsService:e.statisticsService,capiStartAckMessage:e.capiStartAckMessage,pushedContentService:e.pushedContentService})),n.next(null)}catch(t){e.telemetry.error("DocumentActivations error",t),n.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),n.complete()}});return()=>{r.unsubscribe(),s.forEach((e=>e.dispose())),I.releaseReferenceFromDocument(t)}})),A=new d.y((n=>{const s=[],r=(0,i.a)([_(),e.textFieldSupportsAgents]).subscribe({next:([r,i])=>{try{const e=r.runTextDecorationActivations({documentId:t,textFieldSupportsAgents:i});s.push(e),n.next(e.integrations)}catch(t){e.telemetry.error("TextDecorationActivations error",t),n.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),n.complete()}});return()=>{r.unsubscribe(),s.forEach((e=>e.dispose()))}})),D=new d.y((n=>{const s=[],r=(0,i.a)([_(),e.textFieldSupportsAgents]).subscribe({next:([r,i])=>{try{const e=r.runInlineCardActivations({documentId:t,textFieldSupportsAgents:i});s.push(e),n.next(e.integrations)}catch(t){e.telemetry.error("InlineCardActivations error",t),n.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),n.complete()}});return()=>{r.unsubscribe(),s.forEach((e=>e.dispose()))}}));return C.pipe((0,p.x)(),(0,r.w)((e=>e?(0,i.a)([x,A,D]).pipe((0,o.U)((([e,t,n])=>({textDecorationIntegrations:t,inlineCardIntegrations:n})))):(0,m.of)(null))))}I._contentScriptBusClient=null,I._contentScriptInstance=null,I._documentGroupInstance=null,I._documentReferences=new Set}}]);