(self.webpackChunk=self.webpackChunk||[]).push([[5320],{19194:(e,t,s)=>{s.d(t,{N:()=>n});var i=s(8867);function n(e){return new i.y((t=>{const s=new DisposableStack,i=s.use(e());return s.adopt(i.subscribe((e=>t.next(e))),(e=>e.unsubscribe())),()=>s.dispose()}))}},10556:(e,t,s)=>{s.d(t,{D8:()=>n.D,N4:()=>o.N,TJ:()=>n.T,kX:()=>i.k});var i=s(16386),n=s(24071),o=s(19194)},94198:(e,t,s)=>{s.r(t),s.d(t,{AgentsSidePanelIntegration:()=>nt});var i=s(92379),n=s(54784),o=s(69088);var r=s(90572),a=s(10556),l=s(13391),c=s(94857),u=s(78767),d=s(40594),h=s(82307),p=s(1651),m=s(50204);const b={events:{documentSessionDisposed:(0,p.d)()},state:{activeTabId:(0,m.x)(),"activeDocument/:tabId":(0,m.x)(),lastActivePanelAgentId:(0,m.x)(),activePanelAgentId:(0,m.x)()}};var v,f,g,k=s(74822),w=s(21070),y=s(79256),I=s(18519),_=s(71051),S=e=>{throw TypeError(e)},P=(e,t,s)=>t.has(e)||S("Cannot "+s),A=(e,t,s)=>(P(e,t,"read from private field"),s?s.call(e):t.get(e)),C=(e,t,s)=>t.has(e)?S("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),D=(e,t,s,i)=>(P(e,t,"write to private field"),t.set(e,s),s);class M{constructor(e){C(this,v,new DisposableStack),C(this,f,new Map),C(this,g),D(this,g,e)}send(e){A(this,g).send(e)}subscribe(e){const t=new DisposableStack;t.defer((()=>{const t=A(this,f).get(e);null==t||t[Symbol.dispose](),A(this,f).delete(e)}));const s=new DisposableStack;return A(this,f).set(e,s),null!==A(this,g)&&s.use(A(this,g).subscribe(e)),t}connectToServerPort(e){D(this,g,e);for(const[e,t]of A(this,f)){t[Symbol.dispose]();const s=A(this,g).subscribe(e);A(this,f).set(e,s)}}[Symbol.dispose](){A(this,v).dispose()}}v=new WeakMap,f=new WeakMap,g=new WeakMap;var x=s(49486),B=s(76352),W=s(76890);function O(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(((e,s)=>O(e,t[s])));if(Array.isArray(e)!==Array.isArray(t))return!1;const s=Object.keys(e),i=new Set(Object.keys(t));if(s.length!==i.size)return!1;for(const n of s)if(!i.has(n)||!O(e[n],t[n]))return!1;return!0}var $,T,j,N,E,R,F,V,q,G,X,z,K,Y,H,J,L,U,Q,Z,ee,te,se,ie,ne,oe,re,ae,le,ce,ue,de,he,pe,me,be,ve=s(94311),fe=Object.defineProperty,ge=Object.defineProperties,ke=Object.getOwnPropertyDescriptors,we=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable,_e=e=>{throw TypeError(e)},Se=(e,t,s)=>t in e?fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,Pe=(e,t)=>{for(var s in t||(t={}))ye.call(t,s)&&Se(e,s,t[s]);if(we)for(var s of we(t))Ie.call(t,s)&&Se(e,s,t[s]);return e},Ae=(e,t,s)=>t.has(e)||_e("Cannot "+s),Ce=(e,t,s)=>(Ae(e,t,"read from private field"),s?s.call(e):t.get(e)),De=(e,t,s)=>t.has(e)?_e("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),Me=(e,t,s,i)=>(Ae(e,t,"write to private field"),t.set(e,s),s),xe=(e,t,s)=>(Ae(e,t,"access private method"),s);class Be{constructor(e){var t,s;De(this,z),De(this,$,new DisposableStack),De(this,T),De(this,j),De(this,N),De(this,E),De(this,R,!1),De(this,F,null),De(this,V,Ce(this,$).adopt(new Map,(e=>e.clear()))),De(this,q,Ce(this,$).adopt(new Map,(e=>e.clear()))),De(this,G,Ce(this,$).adopt(new Map,(e=>e.clear()))),De(this,X,Ce(this,$).adopt(new Map,(e=>e.clear()))),Me(this,T,e.serverPort),Me(this,j,null!=(t=e.tracingOptions)?t:{enabled:!1}),Me(this,N,e.retainedValueStorage),Me(this,E,`${(0,ve.v)()}${void 0!==e.name?`(${e.name})`:""}`),Ce(this,$).use(null==(s=Ce(this,T))?void 0:s.subscribe((e=>xe(this,z,Y).call(this,e)))),Ce(this,$).defer((()=>{var t;return null==(t=e.retainedValueStorage)?void 0:t.clear()})),void 0!==Ce(this,T)&&this.connect()}isConnected(){return!Ce(this,R)}waitConnected(){var e,t;return null!=(t=null==(e=Ce(this,F))?void 0:e.promise)?t:Promise.resolve()}connect(){return((e,t,s)=>new Promise(((i,n)=>{var o=e=>{try{a(s.next(e))}catch(e){n(e)}},r=e=>{try{a(s.throw(e))}catch(e){n(e)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,r);a((s=s.apply(e,t)).next())})))(this,null,(function*(){var e;if(!Ce(this,T))return Promise.resolve();null==(e=Ce(this,F))||e.reject(new Error("Connection attempt superseded by a newer one")),Me(this,R,!0),Ce(this,X).forEach((e=>e.setBufferingEnabled(!0)));const t=`${Ce(this,E)}|${(0,ve.v)()}`,s=(0,W.B)();return Me(this,F,{attempId:t,resolve:()=>{var e;(null==(e=Ce(this,F))?void 0:e.attempId)===t&&(Me(this,R,!1),Me(this,F,null),Ce(this,X).forEach((e=>e.setBufferingEnabled(!1))),s.resolve())},reject:e=>{var i;(null==(i=Ce(this,F))?void 0:i.attempId)===t&&(Me(this,R,!1),Me(this,F,null),s.reject(e))},promise:s.promise}),Ce(this,T).send({kind:"handshake",id:t,subscriptions:[...Ce(this,V).values()].map((e=>({key:e.key,clientId:e.clientId,subscriptionId:e.portId,timestamp:e.timestamp}))),retainedValues:[...Ce(this,G).entries()].map((([e,t])=>({key:e,value:t.value,clientId:t.lastWriterClientId,timestamp:t.modifiedTimestamp})))}),s.promise}))}createPort(e){const t=null==e?void 0:e.name,s=`${Ce(this,E)}|${(0,ve.v)()}${void 0!==t?`(${t})`:""}`,i=Ce(this,$).use(new We({send:e=>xe(this,z,L).call(this,s,e),notifyDispose:()=>xe(this,z,K).call(this,s),shouldBufferMessages:Ce(this,R),tracingOptions:void 0!==(null==e?void 0:e.tracingOptions)?e.tracingOptions:Ce(this,j),portId:s}));return Ce(this,X).set(s,i),i}[Symbol.dispose](){Ce(this,$).dispose()}}$=new WeakMap,T=new WeakMap,j=new WeakMap,N=new WeakMap,E=new WeakMap,R=new WeakMap,F=new WeakMap,V=new WeakMap,q=new WeakMap,G=new WeakMap,X=new WeakMap,z=new WeakSet,K=function(e){const t=Ce(this,X).get(e);if(void 0!==t){for(const[t,s]of Ce(this,V).entries())s.portId===e&&xe(this,z,se).call(this,e,{kind:"unsubscribe",subscriptionId:t});t[Symbol.dispose](),Ce(this,X).delete(e)}},Y=function(e){switch(e.kind){case"publish":xe(this,z,J).call(this,e);break;case"handshake-ack":xe(this,z,H).call(this,e)}},H=function(e){var t;(null==(t=Ce(this,F))?void 0:t.attempId)===e.id&&Ce(this,F).resolve()},J=function(e){var t,s;const i=Ce(this,G).get(e.key);if(void 0!==i){if(e.timestamp<i.modifiedTimestamp)return;Ce(this,G).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=Ce(this,N))||t.set(e.key,e.value)}if(null==(s=e.route)||!s.includes(Ce(this,E)))return void 0!==e.toSubscriptionId?xe(this,z,ie).call(this,e):void 0!==e.toClientId?xe(this,z,ne).call(this,e):xe(this,z,oe).call(this,e)},L=function(e,t){switch(t.kind){case"publish":xe(this,z,U).call(this,t);break;case"subscribe":xe(this,z,Z).call(this,e,t);break;case"unsubscribe":xe(this,z,se).call(this,e,t);break;case"handshake":xe(this,z,Q).call(this,e,t)}},U=function(e){var t,s,i;const n=Ce(this,G).get(e.key);void 0!==n&&e.timestamp>=n.modifiedTimestamp&&(Ce(this,G).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=Ce(this,N))||t.set(e.key,e.value));const o=((e,t)=>ge(e,ke(t)))(Pe({},e),{route:[...null!=(s=e.route)?s:[],Ce(this,E)]});void 0!==e.toClientId?xe(this,z,ne).call(this,o):xe(this,z,oe).call(this,o),null==(i=Ce(this,T))||i.send(o)},Q=function(e,t){var s,i;const n=Ce(this,X).get(e);if(void 0!==n){for(const s of t.subscriptions)xe(this,z,ee).call(this,{key:s.key,portId:e,timestamp:s.timestamp,clientId:s.clientId,subscriptionId:s.subscriptionId});for(const e of t.retainedValues)Ce(this,G).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(s=Ce(this,N))||s.set(e.key,e.value);n.outbound({kind:"handshake-ack",id:t.id}),null==(i=Ce(this,T))||i.send(t)}else(0,x.P)("No port for handshake message",e)},Z=function(e,t){var s;Ce(this,V).has(t.subscriptionId)?(0,x.P)("Subscription with this id already exists",t.subscriptionId):(xe(this,z,ee).call(this,Pe({portId:e},t)),void 0!==t.retain&&xe(this,z,te).call(this,t,t.retain.value,e),null==(s=Ce(this,T))||s.send(t))},ee=function(e){const t={key:e.key,portId:e.portId,timestamp:e.timestamp,clientId:e.clientId};Ce(this,V).set(e.subscriptionId,t);let s=Ce(this,q).get(e.key);void 0===s&&(s=new Set,Ce(this,q).set(e.key,s)),s.add(e.subscriptionId)},te=function(e,t,s){var i,n,o,r,a;if("write"===(null==(i=e.retain)?void 0:i.kind)&&e.timestamp>=(null!=(o=null==(n=Ce(this,G).get(e.key))?void 0:n.modifiedTimestamp)?o:Number.MIN_SAFE_INTEGER)&&!O(t,null==(r=Ce(this,G).get(e.key))?void 0:r.value))Ce(this,G).set(e.key,{value:t,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(a=Ce(this,N))||a.set(e.key,t),void 0!==Ce(this,X).get(s)&&xe(this,z,oe).call(this,{kind:"publish",key:e.key,value:t,timestamp:e.timestamp,clientId:e.clientId,route:[Ce(this,E)],excludeSubscriptionId:e.subscriptionId});else{const i=Ce(this,G).get(e.key);if(void 0===i)return;void 0!==Ce(this,X).get(s)&&!O(t,i.value)&&xe(this,z,ie).call(this,{kind:"publish",key:e.key,value:i.value,timestamp:i.modifiedTimestamp,clientId:i.lastWriterClientId,route:[Ce(this,E)],toSubscriptionId:e.subscriptionId})}},se=function(e,t){var s,i;const n=Ce(this,V).get(t.subscriptionId);if(void 0===n)return void(0,x.P)("No subscription with this id",t.subscriptionId);if(n.portId!==e)return void(0,x.P)("Subscription does not belong to this port",t.subscriptionId,e);Ce(this,V).delete(t.subscriptionId);const o=Ce(this,q).get(n.key);void 0!==o&&(o.delete(t.subscriptionId),0===o.size&&(Ce(this,q).delete(n.key),Ce(this,G).delete(n.key),null==(s=Ce(this,N))||s.delete(n.key))),null==(i=Ce(this,T))||i.send(t)},ie=function(e){const t=Ce(this,V).get(e.toSubscriptionId);if(void 0===t)return void(0,x.P)("No subscription with this id",e.toSubscriptionId);const s=Ce(this,X).get(t.portId);void 0!==s?s.outbound(e):(0,x.P)("No port for subscription with this id",e.toSubscriptionId)},ne=function(e){const t=xe(this,z,re).call(this,e.key,e.toClientId,void 0);for(const s of t)s.outbound(e)},oe=function(e){const t=xe(this,z,re).call(this,e.key,void 0,e.excludeSubscriptionId);for(const s of t)s.outbound(e)},re=function(e,t,s){const i=new Set,n=Ce(this,q).get(e);for(const e of null!=n?n:[]){if(void 0!==s&&e===s)continue;const n=Ce(this,V).get(e);if(void 0===n||void 0!==t&&t!==n.clientId)continue;const o=Ce(this,X).get(n.portId);void 0!==o&&i.add(o)}return i};class We{constructor(e){var t;De(this,pe),De(this,ae,new DisposableStack),De(this,le),De(this,ce),De(this,ue,Ce(this,ae).use(new B.x)),De(this,de,[]),De(this,he),Me(this,ce,e.send),Me(this,he,e.shouldBufferMessages),Ce(this,ae).defer((()=>e.notifyDispose())),Me(this,le,null!=(t=e.tracingOptions)?t:{enabled:!1}),this.portId=e.portId}send(e){xe(this,pe,be).call(this,"inbound",e),Ce(this,he)&&"handshake"!==e.kind?Ce(this,de).push(e):(xe(this,pe,me).call(this),Ce(this,ce).call(this,e))}subscribe(e){const t=new DisposableStack;return Ce(this,ae).defer((()=>t.dispose())),t.use(Ce(this,ue).subscribe({next:e,complete:()=>t.dispose()})),t}[Symbol.dispose](){Ce(this,ae).dispose()}outbound(e){xe(this,pe,be).call(this,"outbound",e),Ce(this,ue).next(e)}setBufferingEnabled(e){Me(this,he,e),e||xe(this,pe,me).call(this)}}ae=new WeakMap,le=new WeakMap,ce=new WeakMap,ue=new WeakMap,de=new WeakMap,he=new WeakMap,pe=new WeakSet,me=function(){if(Ce(this,de).length>0){for(const e of Ce(this,de))Ce(this,ce).call(this,e);Ce(this,de).length=0}},be=function(e,t){};class Oe extends Be{constructor(e){super(e)}}var $e=s(99161);function Te(e,t){const s=new DisposableStack,i=e.createPortConnection($e.Tt.messageBusPort),n=new k.x;return i.onDisconnect((()=>{s.disposed||t()})),i.onMessage((e=>{s.disposed||n.next(e)})),{send:e=>{s.disposed||i.postMessage(e)},subscribe:e=>{const t=s.use(new DisposableStack);return t.adopt(n.subscribe(e),(e=>e.unsubscribe())),t},[Symbol.dispose]:()=>s.dispose()}}class je{constructor(e){this._init=e,this._baseDisposables=new DisposableStack,this._reconnectSubject=new k.x,this._volatileMessageBusServerPort=this._baseDisposables.use(Te(this._init.message,(()=>this._reconnectSubject.next()))),this._messageBusServerPort=this._baseDisposables.use(new M(this._volatileMessageBusServerPort)),this._messageBusContentScriptRouter=this._baseDisposables.use(new Oe({tracingOptions:{enabled:!1,color:"green"},serverPort:this._messageBusServerPort,name:this._init.routerName})),this._baseDisposables.adopt(this._reconnectSubject.pipe((0,w.z)((()=>(0,y.P)((()=>(this._volatileMessageBusServerPort=this._baseDisposables.use(Te(this._init.message,(()=>this._reconnectSubject.next()))),this._messageBusServerPort.connectToServerPort(this._volatileMessageBusServerPort),this._messageBusContentScriptRouter.connect()))).pipe((0,I.V)(1e3),(0,_.X)({count:5}))))).subscribe(),(e=>e.unsubscribe()))}createPort(...e){return this._messageBusContentScriptRouter.createPort(...e)}[Symbol.dispose](){this._baseDisposables.dispose()}}function Ne(e){return`agents/${e}`}function Ee(e,...t){return Re(e,...t)}function Re(e,...t){return`agents/@impl/${e}${Ge(t)}`}function Fe(e,t,...s){return Ve(e,t,...s)}function Ve(e,t,...s){return`${Ne(e)}/${t}${Ge(s)}`}function qe(e,...t){return`agents/${e}${Ge(t)}`}function Ge(e){const t=e.filter(Boolean).join("/");return t?`/${t}`:""}class Xe{constructor(e){this._disposables=new DisposableStack,this._messageBusRouter=this._disposables.use(new je({message:e.message,routerName:qe(e.script,e.tabId)})),this.platformBus=this._disposables.use((0,a.kX)({port:this._messageBusRouter.createPort({name:Ee(e.script,e.tabId)}),clientId:Re(e.script,e.tabId),keyPrefix:"agents/@impl",protocol:b}))}createPort(...e){return this._messageBusRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}}var ze=s(80891);class Ke{constructor(e){this._experimentClient=e}isAssigned(e,...t){if(e instanceof ze.Cc)return this._experimentClient.isGateEnabled(e);const s=this._experimentClient.getTreatment(e);return null!==s&&s!==ze.q4&&t.includes(s)}getTreatment(e){const t=this._experimentClient.getTreatment(e);return t===ze.q4?null:t}peekExperiment(e,...t){const s=this._experimentClient.peekTreatment(e);return null!==s&&s!==ze.q4&&t.includes(s)}}var Ye=s(12518),He=s(35218),Je=s(6219);const Le=e=>{const t=new Set;return"edge"!==e.browser&&"msie"!==e.browser&&t.add(Je.L.Flag.supportsSVGDominantBaseline),{has:e=>t.has(e)}};class Ue{constructor(){this.openUrl=e=>(0,Ye.Y3)((()=>{document.location.href=e.toString()}),Ye.KC),this.openPopup=e=>(0,Ye.Y3)((()=>{const t=self.open(e.toString(),"_blank","noopener,noreferrer");t&&(t.opener=null)}),Ye.KC)}}var Qe=s(24196),Ze=s(24666),et=s(20161),tt=s(84714);var st=s(40795);function it(e){return{[Symbol.asyncDispose]:async()=>{if(!e)return;const t=await e;t&&(!function(e){return Symbol.dispose in e}(t)?function(e){return Symbol.asyncDispose in e}(t)&&await t[Symbol.asyncDispose]():t[Symbol.dispose]())}}}class nt{constructor(e){this._initOptions=e,this._disposables=new AsyncDisposableStack,this._logger=d.Y.create("AgentsSidePanelIntegration"),this._experimentationService=new Ke(this._initOptions.experimentClient),this._agentDefinitions=(0,st.c)(this._initOptions.experimentClient),this._messageBusClient=this._disposables.use(new Xe({message:(0,h.O)().browserApi.message,script:"side-panel"})),this._agentPlatformBus=this._messageBusClient.platformBus,this._activePanelAgentId=this._disposables.use(this._agentPlatformBus.state.lastActivePanelAgentId.create(null))}setActiveAgentId(e){this._activePanelAgentId.set(e)}loadAssistantAgents(){if(!(0,Qe.w4)(this._initOptions.experimentClient))return l.h.create([]);const e=this._runAssistantActivations(),t=l.h.create(new Map(e.map((e=>[e.agentId,null]))));for(const s of e){const{agentId:e,integrationResult:n}=s;n.then((s=>{s?t.modify((t=>{const n=i.memo((e=>s.renderIcon(e)));n.displayName=`Icon-${e}`;const o=i.memo((()=>s.renderPanel({onClosePanel:void 0})));return o.displayName=`Panel-${e}`,new Map(t).set(e,{id:e,title:s.title,renderPanel:()=>i.createElement(o),renderIcon:e=>i.createElement(n,e)})})):this._logger.debug(`Agent ${e} was not activated due to allowed features check`)})).catch((t=>{this._logger.error(`Failed to get assistant integration result for agent ${e}`,t)}))}return t.view((e=>[...e.values()].filter(u.C_)))}async _getAllowedFeatures(){if(!this._initOptions.experimentClient.isGateEnabled(Qe.Nl.AgentsCAPIFiltering))return this._logger.debug("CAPI filtering gate is disabled, using all agents"),null;const e=this._initOptions.checkingServiceProvider.getCheckingService();if(!e)return this._logger.debug("No checking service available, skipping all agents"),[];try{const a=e=>"start"===e.action,l=(await(t=e.capiMessages.pipe((0,r.h)(a)),i="object"==typeof s,new Promise((function(e,r){var a=new o.Hp({next:function(t){e(t),a.unsubscribe()},error:r,complete:function(){i?e(s.defaultValue):r(new n.K)}});t.subscribe(a)})))).allowedFeatures||[];return this._logger.debug("Received allowed features from CAPI:",l),l}catch(e){return this._logger.error("Failed to get allowed features from CAPI:",e),[]}var t,s,i}_runAssistantActivations(){const e=c.W.detect(),t=function(e){return new He.f(Le(e),new Ue)}(e),s={activeDocument:this._disposables.use(function(e){const t=new DisposableStack,s=t.use(e.state.activeTabId.view(null)),i=l.h.create(null);return t.adopt(s.pipe((0,Ze.x)(),(0,et.w)((t=>null===t?(0,tt.of)(null):(0,a.N4)((()=>e.state.activeDocument.view(t,null)))))).subscribe((e=>i.set(e))),(e=>e.unsubscribe())),{activeDocument:i,[Symbol.dispose]:()=>t.dispose()}}(this._agentPlatformBus)).activeDocument,documentSessionDisposed:this._agentPlatformBus.events.documentSessionDisposed.view()},i={user:this._initOptions.user.view((e=>({id:e.id,firstName:e.firstName,email:e.email,free:!e.premium,anonymous:e.anonymous})))},n=this._getAllowedFeatures();return this._agentDefinitions.map((o=>{const r=n.then((async n=>{var r,l;if(null!==n){const e=st.i[o.id];if(e&&!n.includes(e))return this._logger.debug(`Agent ${o.id} requires feature ${e} which is not in allowed features, skipping activation`),null}this._logger.debug(`Running assistant activation for ${o.id}`);const c=new AsyncDisposableStack;this._disposables.defer((()=>c.disposeAsync()));const u=c.use(this._messageBusClient.createPort({name:Fe(o.id,"assistant")})),d=null===(l=(r=o.integrations).assistantActivate)||void 0===l?void 0:l.call(r,{bus:c.use((0,a.kX)({port:u,clientId:Ve(o.id,"assistant"),keyPrefix:Ne(o.id),protocol:o.protocol})),documents:s,navigation:{isPanelOpen:this._activePanelAgentId.view((e=>e===o.id))},experimentation:this._experimentationService,platformInfo:e,environment:t,userService:i});return c.use(it(d)),d||(c.disposeAsync(),null)}));return{agentId:o.id,integrationResult:r}}))}dispose(){this._disposables.disposeAsync()}}}}]);