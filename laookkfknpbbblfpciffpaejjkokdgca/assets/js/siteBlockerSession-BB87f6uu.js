import{M as e,d as t}from"./DataSyncService-BIQVYvDv.js";import{u as s,a as i}from"./siteBlockerGroups-DVPsrCxl.js";import{c as o,d as a}from"./constants-3_GhJRHQ.js";import{p as r}from"./promisifiedChrome-vGTrjPj6.js";import{g as n,u as c,C as d,M as p,D as l,E as u}from"./index-B9SbLlJ5.js";import{d as g,F as h}from"./state-C7K8Oenp.js";import{useFocusModeDashViewStateStore as b}from"./focusModeViewState-CobNuKLk.js";import{u as f,l as S}from"./pomodoroCompleted-BqUMo7o_.js";import{computed as j,computedObjectSettings as v}from"./reactiveCustomization-l1DAJU8W.js";import{o as M,a as w}from"./modal-DQlfZdMt.js";import{U as P}from"./enums-C0TfsRui.js";import{s as k,a as T,b as B}from"./state-B00254AG.js";import{g as y}from"./settings-ClOtDILp.js";import{p as A}from"./persistStore-C6CQfgEA.js";import"./Logger-BTKFyPnc.js";import"./ErrorPulseInput-CkNsRuJq.js";import"./compareObjects-R6Hcs7xe.js";import"./style-cpFB66wV.js";import"./LocalStorageStoreSyncedItem-ClHii6kh.js";import"./ViewState-CaQI4PuO.js";import"./appZStack-Duidf5Sm.js";import"./index-FW5FYBiS.js";import"./PomodoroTimers-CqOVDo7T.js";import"./login-D3lslwtx.js";import"./authService-dK6ZN9yA.js";import"./auth-B1eW30AJ.js";import"./legacyUserMigration-BBmM2Q1F.js";import"./migrateLegacyUserMessageHandler-BMN9RYlR.js";import"./onboarding-DKrOugBj.js";const E=A((({loadedRef:e,updateAsync:r})=>{const A=t("siteBlockerSession",{state:()=>({hasPermissions:!1,manuallyActive:!1,gracePeriodTimestamp:0,unstoppableModeTimestamp:0}),getters:{loaded:()=>e.value,urls:()=>[...s().items.reduce(((e,t)=>t.enabled?(i().getWebsitesByGroup(t).filter((e=>e.enabled)).forEach((t=>e.add(t.hostWithWildcard))),e):e),new Set([]))].join(" "),settingsEnabled:()=>j.siteBlockerVisible,focusModeEnabledAndFocusModeSettingActive(){var e;return g.currentValue&&((null==(e=y().apps.siteBlocker)?void 0:e.enabled)??!0)&&b().activeViewId===h.Focusing.toString()},featureEnabled:()=>m.conditionalFeatures.featureEnabled("site-blocker")||g.currentValue,active(e){if(!this.settingsEnabled||!this.featureEnabled)return!1;const t=f(),s=this.focusModeEnabledAndFocusModeSettingActive&&t.playing,i=s&&t.anyFocusTimerActive&&!this.activeDuringPomodoroBreak;if(this.unstoppableModeActive)return this.unstoppableModeTimestamp;if(i)return t.timeStarted+t.totalLength;const o=s&&this.activeDuringPomodoroBreak;return e.manuallyActive||o},activeAndBlockingUrls(e){return!!this.active&&e.hasPermissions&&0!==s().items.length},gracePeriodTimeRemainingSeconds:e=>Math.floor((e.gracePeriodTimestamp-m.models.date.get("seconds").getTime())/p),gracePeriodActive(){return this.gracePeriodTimeRemainingSeconds>0},actionsDisabled(){return!!this.active&&!this.gracePeriodActive},siteBlockerSettings:()=>v.siteBlockerSettings,activeDuringPomodoroBreak(){return this.siteBlockerSettings.activeDuringPomodoroBreak},unstoppableModeFeatureEnabled:()=>m.conditionalFeatures.featureEnabled("site-blocker"),unstoppableModeTimeRemainingSeconds:e=>Math.floor((e.unstoppableModeTimestamp-m.models.date.get("seconds").getTime())/p),unstoppableModeActive(){return S.get("unstoppableModeActive",(()=>this.unstoppableModeTimeRemainingSeconds>0))}},actions:{async update(e){await r(e)},async ensurePermissions(e=!1){return this.hasPermissions?await this.registerOrUpdateContentScript():M(o,{source:"Site Blocker",reason:"To block sites while focusing",requestImmediately:e,extraInstructions:l()?' Please select "Always allow on every website..."':"",watchPermissionCheck:!0}).then((async e=>!!e&&(await this.update({hasPermissions:!0}),await this.registerOrUpdateContentScript(),!0)))},async registerOrUpdateContentScript(){if(!n().scripting)return;return!!(await n().scripting.getRegisteredContentScripts()).length||await new Promise((e=>{n().scripting.registerContentScripts([{id:"site-blocker",js:["/content-scripts/siteBlocker.js"],matches:["*://*/*"],runAt:"document_start"}],(()=>e(!0)))}))},checkSiteBlockerFeatureDisabledAndOpenUpsell(){return!this.featureEnabled&&(w(P.SITE_BLOCKER,"site-blocker"),!0)},startGracePeriod(){this.update({gracePeriodTimestamp:Date.now()+a})},stopGracePeriodTimeout(){this.update({gracePeriodTimestamp:Date.now()})},startUnstoppableMode(){const e=Date.now()+this.siteBlockerSettings.unstoppableModeDurationMinutes*u;this.update({unstoppableModeTimestamp:e})},stopUnstoppableMode(){this.update({unstoppableModeTimestamp:Date.now()})}}});return(async()=>{const e=A(),t=s(),o=i(),a=f();await c((()=>e.loaded)).toBe(!0),await c((()=>a.loaded)).toBe(!0),k.switchOverToWatchedStoreItem((()=>e.active)),T.switchOverToWatchedStoreItem((()=>e.unstoppableModeTimestamp)),e.hasPermissions&&e.active&&e.registerOrUpdateContentScript(),d([()=>g.currentValue,()=>e.featureEnabled,()=>e.settingsEnabled,()=>e.unstoppableModeActive],(([t,s,i,o])=>{s&&i&&t&&!o||e.stopGracePeriodTimeout()})),await c((()=>t.loaded)).toBe(!0),await c((()=>o.loaded)).toBe(!0),B.switchOverToWatchedStoreItem((()=>e.urls))})(),A}),{mode:e.Cache,syncAutomatically:!0,fixStateBeforeLoad:async e=>n().permissions?(e.hasPermissions=await r.permissions.contains(o),e):e});export{E as default};