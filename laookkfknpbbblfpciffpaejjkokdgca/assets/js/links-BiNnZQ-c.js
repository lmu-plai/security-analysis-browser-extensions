import{t,D as e,M as i,d as s}from"./DataSyncService-BIQVYvDv.js";import{L as a,a as n,aC as r,V as d}from"./index-B9SbLlJ5.js";import{d as l,E as o}from"./constants-Bt_TxKWw.js";import{u as c}from"./Logger-BTKFyPnc.js";import{M as h}from"./compareObjects-R6Hcs7xe.js";import{P as u}from"./pinia-4ulFHh2N.js";function p(t){return t.type===l.LinkGroup&&!t.isRoot}function m(t){return t.type===l.Legacy}function k(t){return t.type===l.Link}function g(t){return t.type===l.LinkGroup&&"isRoot"in t&&t.isRoot&&!("isTeamRoot"in t&&t.isTeamRoot)}function I(t){return t.type===l.LinkGroup&&"isTeamRoot"in t&&t.isTeamRoot}class f{constructor({id:t=c(),url:e=""}={}){this.id=t,this.url=e}}class w{constructor({id:t=n.uuidv4(),links:e=[],title:i="",pinned:s=!1,readOnly:a=!1}={}){this.id=t,this.links=e.map((t=>new f(t))),this.title=i,this.pinned=!!s,this.readOnly=a}get hasManyLinks(){return this.links.length>1}}function b({title:t,links:e}){if(0===t.length)throw new a({message:o.TITLE_EMPTY,input:"title"});if(0===e.length)throw new a({message:o.URL_EMPTY,input:"links.0"});e.forEach(((t,i)=>{(t.url||1===e.length)&&function({url:t},e){const i="links"+(void 0===e?"":`.${e}`);if(!t)throw new a({message:o.URL_EMPTY,input:i});if(!n.isValidUrl(t))throw new a({message:o.URL_INVALID,input:i})}(t,i)}))}class v{constructor(t){this.dataService=t}get(e){this.dataService.get({...e,success:i=>{(async()=>{var s;1===i.filter(g).length?e.success(i):0!==(null==(s=await t.get("links"))?void 0:s.cache)&&(await t.patch("links",{cache:0}),this.dataService.get(e))})()}})}create(t){return this.dataService.create(t.id,t)}update(t,e){return this.dataService.update(t,e)}delete(t){return this.dataService.delete(t)}}function y(t){return[{id:t.id,title:t.title,pinned:t.pinned,type:l.LinkGroup,readOnly:!1,linksOrderIds:t.links.map((t=>t.id))},...t.links.map((e=>({id:e.id,type:l.Link,url:e.url,parentLinkId:t.id})))]}function L(t){const e=Object.assign(new w,t);return e.links=e.links.filter((t=>t.url.length)).map((t=>Object.assign(new f,t,{url:t.url.includes("://")?t.url:"https://"+t.url}))),e}class O{constructor({id:t,url:e,title:i,pinned:s=!1,readOnly:a=!1}={}){if(!t||void 0===i||!e)throw new Error("Legacy link created with incomplete data");this.id=t,this.links=[new f({url:e})],this.title=i,this.pinned=!!s,this.readOnly=a}get hasManyLinks(){return this.links.length>1}}const E=new class{constructor(){this.draggables={},this.activeDraggable=null,this.droppables={},this.sortables={},this.sortableLists={},this.sortableCallbacks={}}},R=(t,e)=>{var i,s;(i=E.sortableCallbacks)[t]??(i[t]=new Set([])),null==(s=E.sortableCallbacks[t])||s.add(e),r((()=>S(t,e)))},S=(t,e)=>{var i,s;null==(i=E.sortableCallbacks[t])||i.delete(e),0===(null==(s=E.sortableCallbacks[t])?void 0:s.size)&&delete E.sortableCallbacks[t]},j=(t=(()=>({linksService:new v(new e("links",{mode:i.Timestamp}))}))().linksService)=>{const a=s("links",{plugins:[u.MockData],state:()=>({data:{},loading:!1,loaded:!1,activeItemId:"",activeItem:null}),getters:{service:()=>t,getItems(){return({pinned:t=!1,team:e=!1}={})=>{var i;const s=e?this.getTeamRoot:this.getRoot;if(!s)return[];const a=[];return null==(i=s.linksOrderIds)||i.forEach((e=>{const i=this.getItemById(e);if(i&&(p(i)||m(i))&&(e=>"pinned"in e?e.pinned===t:!t)(i)){let t;p(i)?t=this.buildLinkGroup(i):m(i)&&(t=new O(i)),t&&t.links.length&&a.push(t)}})),a}},getUnPinnedItems(){return this.getItems()},getPinnedItems(){return this.getItems({pinned:!0})},getUnPinnedTeamItems(){return this.getItems({team:!0})},getPinnedTeamItems(){return this.getItems({pinned:!0,team:!0})},getRoot:t=>Object.values(t.data).find(g)||null,getTeamRoot:t=>Object.values(t.data).find(I)||null,getItemById:t=>e=>{const i=t.data[e];return i||null},buildLinkGroup(){return t=>{var e;const i=[];null==(e=t.linksOrderIds)||e.forEach((t=>{const e=this.getItemById(t);e&&k(e)&&i.push(e)}));const s={...t,links:i};return new w(s)}},adding(){return!(!this.activeItem||this.activeItemId)}},actions:{addItem(){this.activeItem=new w},editItem(t){this.activeItemId=t;const e=this.getItemById(t);e&&p(e)&&(this.activeItem=this.buildLinkGroup(e))},clearActiveItem(){this.activeItem=null,this.activeItemId=""},refresh(){this.loading||this.loaded||(this.loading=!0,t.get({success:t=>{Object.keys(this.data).forEach((e=>{e in t||delete this.data[e]})),t.forEach((t=>d.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}}))},async updatePartialRootLinksOrderIds(t){const e=this.getRoot;e&&await this.update(e.id,{linksOrderIds:[...new Set([...t,...e.linksOrderIds])]})},async deleteLinkGroup(t){const e=this.getItemById(t);if(!e||!p(e)&&!m(e))throw new Error(`Can't find LinkGroup with id ${t}`);await Promise.allSettled(Object.values(this.data).filter((i=>k(i)&&i.parentLinkId===t||i===e)).map((t=>this.delete(t.id))))},async processMutations(t){t.filter((t=>t.method!==h.Delete&&"linksOrderIds"in t.data)).forEach((e=>{if(e.method===h.Create&&p(e.data)){const i=e.data.linksOrderIds;t.push({method:h.Update,id:e.id,data:{linksOrderIds:i}}),Object.assign(e.data,{linksOrderIds:[]});const s=this.getRoot;if(!s)throw new Error("Can't find RootLink");t.push({method:h.Update,id:s.id,data:{linksOrderIds:[...s.linksOrderIds,e.id]}})}else e.method===h.Update&&(t=t.filter((t=>t!==e))).push(e)}));for(const e of t)switch(e.method){case h.Update:await this.update(e.id,e.data);break;case h.Create:if(g(e.data))throw new Error("Can't create root links");if(I(e.data))throw new Error("Can't create root links");if(m(e.data))throw new Error("Can't create legacy links");await this.create(e.data);break;case h.Delete:{const t=this.getItemById(e.id);if(!t)return;if(g(t))throw new Error("Can't delete root links");if(I(t))throw new Error("Can't delete team root links");await this.delete(e.id);break}}},async create(e){return d.set(this.data,e.id,e),await t.create(e),e},async update(e,i){const s=this.getItemById(e);if(!s)throw new Error(`No data found for ${e}`);const a={...s,...i};return d.set(this.data,e,a),await t.update(e,i),a},async delete(e){return d.delete(this.data,e),t.delete(e)}}}),n=a(),r=async t=>{const e=t.newOrder.map((t=>t.id));await n.updatePartialRootLinksOrderIds(e)};return R("links-dash-pinned-tile",r),R("links-dash-pinned-list",r),R("links-app-pinned",r),R("links-app",r),a},C=j(),T=Object.freeze(Object.defineProperty({__proto__:null,default:C,makeLinksStore:j,useLinksStore:C},Symbol.toStringTag,{value:"Module"}));export{O as L,w as a,L as b,y as c,f as d,E as e,T as l,R as o,C as u,b as v};