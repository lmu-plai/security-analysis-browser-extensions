import{b as e,d as t}from"./DataSyncService-BIQVYvDv.js";import{i as a}from"./index-BENmK416.js";import{g as s}from"./accessToken-BQcp6xmY.js";import{ac as n,ad as r,N as i,ae as d,E as l,af as o,V as c}from"./index-B9SbLlJ5.js";import{m as g}from"./Logger-BTKFyPnc.js";import{persistent as u}from"./reactiveCustomization-l1DAJU8W.js";import"./style-cpFB66wV.js";class h{get(e,t){g.get("calendarData").then((t=>{const a=t;a&&a.length&&e(...a)})),this.refresh(e,t)}async refresh(t,n){var r,i;const d=await s();if(d)try{const{data:a}=await e.get("https://www.googleapis.com/calendar/v3/users/me/calendarList",{params:{access_token:d}}),s=a.items.map((e=>({id:e.id,summary:e.summary,timeZone:e.timeZone,backgroundColor:e.backgroundColor}))),n=(await Promise.all(s.map((e=>this.getCalendarEvents(e,d))))).flat();return await g.set("calendarData",[n,s]),void t(n,s)}catch(l){return console.error(l),void(a(l)&&(null==(i=null==(r=l.response)?void 0:r.status)?void 0:i.toString().startsWith("4"))?(await g.delete("calendarData"),t([],[])):n())}else t([],[])}async getCalendarEvents(t,a){const s=[];try{const{data:i}=await e.get(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(t.id)}/events`,{params:{access_token:a,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,singleEvents:!0,orderBy:"startTime",timeMin:n(-1),timeMax:n(2)}}),d=i.items.filter((e=>{var t;return!(null==(t=e.attendees)?void 0:t.some((e=>!0===e.self&&"declined"===e.responseStatus)))})).map((e=>{var a;return{id:e.id,summary:e.summary||"No title",start:e.start.date?new Date(e.start.date+"T00:00:00.000").getTime():new Date(e.start.dateTime).getTime(),end:e.end.date?new Date(e.end.date+"T00:00:00.000").getTime():new Date(e.end.dateTime).getTime(),color:t.backgroundColor,calendarName:t.summary,calendarId:t.id,allDay:"date"in e.start,meetingLink:r(`${e.location} ${e.description} ${null==(a=e.conferenceData)?void 0:a.entryPoints.map((e=>e.uri||"")).join(" ")}`),link:e.htmlLink}}));s.push(...d)}catch(i){console.error(i),console.warn("No Events For Calendar:",t.summary)}return s}}const v=((e=(()=>({calendarEventService:new h}))().calendarEventService)=>t("calendarEvents",{state:()=>({data:{},loading:!1,loaded:!1,linked:!0,calendars:[],staleDataWarningVisible:!1}),getters:{events(){const e=[(new Date).getDate(),new Date(m.models.date.get("hour").getTime()+i).getDate()];return Object.values(this.data).filter((t=>e.includes(new Date(t.start).getDate())&&!this.excludedCalendars.includes(t.calendarId))).sort(((e,t)=>e.start-t.start))},getEventsForDay(){const e=new Date(m.models.date.get("hour"));return(t=0)=>this.loaded?this.events.filter((a=>d(e,new Date(a.start),0)===t)):[]},currentEvent(){return this.loaded?this.getEventsForDay(0).filter((e=>!e.allDay&&e.end>=m.models.date.get("date").getTime()))[0]??null:null},nextEvent(){return this.loaded?this.getEventsForDay(0).filter((e=>!e.allDay&&e.start>=m.models.date.get("date").getTime()))[0]??null:null},excludedCalendars:()=>JSON.parse(u.excludedCalendars),calendarList(){return this.calendars.map((e=>({...e,enabled:!this.excludedCalendars.includes(e.id)})))},calendarEventLabel(){return this.loading||!this.linked?"-":!1!==this.currentEventProgress?"Now":this.nextEvent?this.nextEvent.start>m.models.date.get("date").getTime()+45*l?Math.round((this.nextEvent.start-m.models.date.get("date").getTime())/o)+"h":Math.round((this.nextEvent.start-m.models.date.get("date").getTime())/l)+"m":"-"},currentEventProgress(){const e=m.models.date.get("date").getTime(),t=this.currentEvent;return!!(t&&t.start<e&&t.end>e)&&(e-t.start)/(t.end-t.start)},currentEventTitle(){var e;return this.loading?"Loading":this.linked?this.currentEvent?null==(e=this.currentEvent)?void 0:e.summary:"No events":"Calendar"}},actions:{refresh(t=!1){(t||!this.loading&&!this.loaded)&&(this.loading=!0,e.get(((e,t)=>{Object.keys(this.data).forEach((t=>{t in e||delete this.data[t]})),e.forEach((e=>c.set(this.data,e.id,e))),this.loaded=!0,this.loading=!1,t&&(this.calendars=t)}),(()=>{this.staleDataWarningVisible=!0})),s().then((e=>{this.linked=null!==e})))}}}))();export{v as useCalendarEventStore};