import{D as t,d as e}from"./DataSyncService-BIQVYvDv.js";import{a as s,D as i,aB as a,g as o,F as n,V as r}from"./index-B9SbLlJ5.js";import{p as d}from"./promisifiedChrome-vGTrjPj6.js";import{u as w}from"./Logger-BTKFyPnc.js";import{o as l}from"./modal-DQlfZdMt.js";class c{constructor({key:t,title:e,url:s,pinned:i,index:a}){this.type=h.Tab,this.key=t,this.title=e,this.url=s,this.pinned=i,this.index=a}}class u{constructor({key:t,tabs:e,index:s,color:i="grey",title:a="",collapsed:o=!1,manifestVersion:n}){this.type=h.Group,this.key=t,this.index=s,this.tabs=e.map((t=>new c(t))).sort(((t,e)=>t.index-e.index)),this.color=i,this.title=a,this.collapsed=o,this.manifestVersion=n||2}}var h=(t=>(t.Tab="Tab",t.Group="Group",t))(h||{});const p=["app","devtools"];class b{constructor({key:t,activeTabKey:e,state:s,type:i,left:a,top:o,width:n,height:r,browserSessionKey:d,tabsAndGroups:w}){this.tabsAndGroups=[],this.key=t,this.activeTabKey=e,this.state=s,this.type=i,this.left=a,this.top=o,this.width=n,this.height=r,d&&(this.browserSessionKey=d),this.tabsAndGroups=w.map((t=>"tabs"in t?new u(t):new c(t))).sort(((t,e)=>t.index-e.index))}get tabCount(){let t=0;return this.tabsAndGroups.forEach((e=>{t+=e instanceof c?1:e.tabs.length})),t}}const f=t=>{if(void 0!==t.id&&void 0!==t.state&&void 0!==t.type&&"app"!==t.type&&"devtools"!==t.type)return{key:t.id,state:t.state,type:t.type,left:t.left||0,top:t.top||0,width:t.width||window.outerWidth,height:t.height||window.outerHeight}};class y{constructor({id:t,name:e,windows:s,activeWindowKey:i,browser:a,dateCreated:o}){this.windows=[],this.id=t,this.name=e,this.windows=s.map((t=>new b(t))),this.activeWindowKey=i,this.browser=a,this.dateCreated=o}get totalTabCount(){return this.windows.map((t=>t.tabCount)).reduce(((t,e)=>t+e))}get displayName(){return this.name||s.getFriendlyDateTime(new Date(this.dateCreated))}get sessionDescriptionTabs(){const t=this.totalTabCount;return`${t} tab${t>1?"s":""}`}get sessionDescriptionWindows(){return`${this.windows.length} window${this.windows.length>1?"s":""}`}}var m=(t=>(t.List="list",t.Detail="detail",t))(m||{});const g={permissions:["tabs","sessions","tabGroups"]},v={permissions:["tabs","sessions"]},S={permissions:["tabs"],origins:["*://*/*"]},T={ERROR_STASH:"Oops, we couldn't save that session at this time.",ERROR_RESTORE:"Oops, we couldn't restore that session at this time.",ERROR_NO_OTHER_TABS:"No tabs to stash.",ERROR_DELETE:"Oops, there was a problem deleting that session.",ERROR_ALL_DELETE:"Oops, there was a problem deleting all sessions.",ERROR_PERMISSIONS:"Oops, we don't have permissions to do that.",SUCCESSFUL_STASH_PARTIAL:" saved to a new session.",SUCCESSFUL_RESTORE_PARTIAL:" session restored.",SUCCESSFUL_ALL_DELETE:"All session deleted.",DELETE_PARTIAL:" session deleted."},W="chrome://newtab/",E="https://get.momentumdash.help/hc/en-us/articles/14474141114391";var A="Chrome",I=(t=>(t.All="all",t.Window="window",t))(I||{});const R=()=>{switch(A){case"Firefox":return v;case"Safari":return S;default:return g}};class C{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}update(t,e){return this.dataService.update(t,e)}delete(t){return this.dataService.delete(t)}async ensurePermissions(t=!1){const e=R();return!!(await d.permissions.contains(e))||l(e,{source:"Tab Stash",reason:"To save your tabs for later",requestImmediately:t,extraInstructions:i()?' Please select "Always allow on every website..."':"",watchPermissionCheck:!0})}async closeWindowsAndSetSessionIds(t){var e;for(const a of t.windows)if(i()){const t=a.tabsAndGroups.flatMap((t=>t.type===h.Tab?[t]:t.tabs)).map((t=>t.key));await d.tabs.remove(t)}else try{if(1===a.tabsAndGroups.length&&(null==(e=a.tabsAndGroups[0])?void 0:e.type)===h.Tab&&a.tabsAndGroups[0].url===W)await d.windows.remove(a.key);else{await d.windows.removeAndWaitForSessionChange(a.key);const t=await d.sessions.getLastClosedSessionId();t&&(a.browserSessionKey=t)}}catch(s){console.warn(s)}return t}async restoreSession(t){const e=t.windows.filter((e=>e.key!==t.activeWindowKey)),s=t.windows.filter((e=>e.key===t.activeWindowKey)),a=await d.permissions.contains(R()),o=await d.tabs.getCurrent();if(!o||!o.id)throw new Error("Could not find active tab id from current window");let n=o.windowId;for(const r of[...e,...s]){const e=r.key===t.activeWindowKey&&a&&1===(await d.tabs.query({currentWindow:!0})).length;if(i()&&e){for(const t of r.tabsAndGroups)await this.openPartialSession(t);n=o.windowId}else if(e){const e=await this.restoreWindow(r,t.browser);if(!e.id)continue;n=e.id,o.pinned&&await d.tabs.update(o.id,{pinned:!1}),await d.tabs.moveToWindow(o.id,e.id),o.pinned&&await d.tabs.update(o.id,{pinned:!0})}else await this.restoreWindow(r,t.browser)}await this.focusTabAndWindow(o.id,n)}async getSessionFromWindows(t){const e=await d.tabs.query({currentWindow:!0}),s=await d.tabs.getCurrent();if(!s||!s.id)throw new Error("could not find active tab id in current window");let o=-1;s&&1!==e.length&&s.id&&(i()||await this.pullTabInNewWindow(s),o=s.windowId);const n={id:w(),name:"",windows:[],activeWindowKey:o,browser:a(),dateCreated:(new Date).toISOString()},r=await d.windows.getAll({windowTypes:["normal"]});for(const i of r){if("window"===t&&i.id!==o)continue;const e=f(i);if(!e)throw new Error(`window returned by browser (${n.browser}) does not satisfy IWindow type`);const a=await this.setTabsDataForWindow(e,n.browser,s.id);a.tabsAndGroups.length&&n.windows.push(a)}return new y(n)}async openPartialSession(t){t instanceof b?await this.fallbackRestoreWindow(t,a()):t instanceof u?await this.createGroup(t):t instanceof c&&await d.tabs.create({url:t.url,pinned:t.pinned})}async createGroup(t){const e=[];for(const s of t.tabs){const t=await d.tabs.create({url:s.url,pinned:s.pinned});t.id&&e.push(t.id)}if(void 0!==chrome.tabs.group){const s=await d.tabs.group({tabIds:e});if(chrome.tabGroups&&3===t.manifestVersion){const{color:e,collapsed:i,title:a}=t;await chrome.tabGroups.update(s,{color:e,collapsed:i,title:a})}}}async pullTabInNewWindow(t){const e=t.id;if(!e)throw new Error("Could not read tab id when pulling out tab from window");const s=await d.windows.get(t.windowId),i=await d.windows.create({tabId:e});if(!i||!i.id)throw new Error("Could not create window when pulling out tab from window");await this.updateWindowSize(i.id,s),t.pinned&&await d.tabs.update(e,{pinned:!0})}async setTabsDataForWindow(t,e,s){var a;const o=await d.tabs.query({windowId:t.key}),n=o.map((t=>{const s=(t=>{if(void 0!==t.id&&void 0!==t.url)return{key:t.id,title:t.title||"",url:t.url,pinned:t.pinned,index:t.index,type:h.Tab}})(t);if(!s)throw new Error(`tab returned by browser (${e})could not be converted to ITab`);return s})).sort(((t,e)=>t.index-e.index)).filter((t=>t.key!==s)).filter((t=>!i()||!t.pinned)),r=[];for(let i=0;i<n.length;i++){const t=n[i],e=o[i];if(t&&e)if(~e.groupId&&void 0!==e.groupId){const t=o.filter((t=>t.groupId===e.groupId)).length;let s={};if(chrome&&chrome.tabGroups){const t=await chrome.tabGroups.get(e.groupId),{color:i,collapsed:a,title:o=""}=t;s={color:i,collapsed:a,title:o,manifestVersion:3}}const a={key:e.groupId,index:i,type:h.Group,tabs:n.slice(i,i+t),...s};i+=t-1,r.push(a)}else r.push(t)}return{...t,activeTabKey:(null==(a=o.find((t=>t.active)))?void 0:a.id)||-1,tabsAndGroups:r}}async restoreWindow(t,e){const s=t.browserSessionKey;let a;return s&&!i()&&(a=await d.sessions.restoreWindow(s)),a||(a=await this.fallbackRestoreWindow(t,e)),a}async fallbackRestoreWindow(t,e){var s,i,a,o,n;const{tabsAndGroups:r,activeTabKey:w,state:l,type:h}=t,b={state:l,type:h},f=r.flatMap((t=>t instanceof c?[t]:t.tabs));b.type&&p.includes(b.type)&&(b.type="normal"),b.url=await this.getUrlArrayForWindowCreateFromTabs(f,e);const y=await d.windows.create(b);if(!y||!y.id)throw new Error("Could not create window");if(await this.updateWindowSize(y.id,t),void 0!==chrome.tabs.group)for(const c of r){if(!(c instanceof u))continue;const t=c.index,e=t+c.tabs.length,i={tabIds:((null==(s=y.tabs)?void 0:s.slice(t,e))||[]).flatMap((t=>void 0===t.id?[]:[t.id])),createProperties:{windowId:y.id}},a=await d.tabs.group(i);if(chrome.tabGroups&&3===c.manifestVersion){const{color:t,collapsed:e,title:s}=c;await chrome.tabGroups.update(a,{color:t,collapsed:e,title:s})}}for(let c=0;c<f.length;c++){const t=f[c];if(null==t?void 0:t.pinned){const t=null==(a=null==(i=y.tabs)?void 0:i[c])?void 0:a.id;if(!t)continue;await d.tabs.update(t,{pinned:!0})}}const m=f.find((t=>t.key===w));if(m){const t=f.indexOf(m),e=null==(n=null==(o=y.tabs)?void 0:o[t])?void 0:n.id;e&&await d.tabs.update(e,{active:!0})}return y}async updateWindowSize(t,e){"normal"===e.state&&e.left&&e.width&&e.top&&e.height&&(await d.windows.update(t,{width:e.width,height:e.height}).catch((t=>console.error(t))),(!i()||window.screen.availWidth>e.left+e.width)&&await d.windows.update(t,{left:e.left,top:e.top}).catch((t=>console.error(t))))}async getUrlArrayForWindowCreateFromTabs(t,e){var s;const r=t=>t.startsWith(e+"-extension://")||t.startsWith(e+"://"),d=await(null==(s=o().extension)?void 0:s.isAllowedFileSchemeAccess()),w=t.map((t=>t.url===W&&(n()||i())?"/index.html":r(t.url)?t.url.replace(e,a()):t.url)).filter((t=>!(r(t)&&n()||t.startsWith("about:")))).filter((t=>!(t=>t.startsWith("file://"))(t)||d));return 0===w.length&&w.push("/index.html"),i()&&w.unshift("/index.html"),w}async focusTabAndWindow(t,e){t&&await d.tabs.update(t,{active:!0}),e&&await d.windows.update(e,{focused:!0})}}const G=()=>({tabStashService:new C(new t("tabs",{useUpdateMask:!0}))}),k=(t=G().tabStashService)=>e("tabs",{state:()=>({data:{},loading:!1,loaded:!1,activeItemId:""}),getters:{getItems:t=>Object.values(t.data).map((t=>new y(t))).sort(((t,e)=>Date.parse(e.dateCreated)-Date.parse(t.dateCreated))),getItemById:t=>e=>{const s=t.data[e];return s?new y(s):null}},actions:{refresh(){this.loading=!0,t.get({success:t=>{t.forEach((t=>r.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}})},async stashSession(e){if(!(await t.ensurePermissions()))return!1;const s=await t.getSessionFromWindows(e);return 0===s.windows.length||(await this.create(s),await t.closeWindowsAndSetSessionIds(s),i()||await this.update(s.id,{windows:s.windows})),s},async restoreSession(e){return!(!i()&&!(await t.ensurePermissions()))&&(await t.restoreSession(e),await this.delete(e.id),!0)},async create(e){r.set(this.data,e.id,e),await t.create(e)},async delete(e){r.delete(this.data,e),await t.delete(e)},async update(e,s){const i=this.data[e];if(!i)throw new Error(`No data found for ${e}`);const a={...i,...s};return r.set(this.data,e,a),await t.update(e,s),a},ensurePermissions:e=>t.ensurePermissions(e)}}),x=k(),O=Object.freeze(Object.defineProperty({__proto__:null,default:x,makeTabsStore:k,useTabsStore:x},Symbol.toStringTag,{value:"Module"}));export{u as G,E as H,W as N,y as S,m as T,b as W,c as a,h as b,I as c,T as m,G as p,O as t,x as u};