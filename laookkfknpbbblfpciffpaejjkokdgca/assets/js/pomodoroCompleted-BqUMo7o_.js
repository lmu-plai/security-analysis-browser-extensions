import{D as t,M as e,e as o,d as s,c as i}from"./DataSyncService-BIQVYvDv.js";import{a,E as r,af as n,M as u,r as c,g as d,n as l,u as p,d as h,w as y,H as g,F as f,A as T,aD as w,ae as S}from"./index-B9SbLlJ5.js";import{t as v,u as P}from"./Logger-BTKFyPnc.js";import{p as _}from"./persistStore-C6CQfgEA.js";import{d as k}from"./state-C7K8Oenp.js";import{a as A,T as D}from"./PomodoroTimers-CqOVDo7T.js";import{persistentObjectSettings as F,computedObjectSettings as M}from"./reactiveCustomization-l1DAJU8W.js";import{p as b}from"./promisifiedChrome-vGTrjPj6.js";import{L as E}from"./LocalStorageStoreSyncedItem-ClHii6kh.js";import{w as I}from"./login-D3lslwtx.js";import{o as B}from"./modal-DQlfZdMt.js";class C{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}update(t,e){return this.dataService.update(t,e)}}const N=t=>t.reduce(((t,e)=>t+(e.manualAdjustment||0===e.focusMinutes?0:Number(e.aggregatedEntries))),0),j=t=>t.reduce(((t,e)=>t+Number(e.focusMinutes)),0);var L=(t=>(t.FocusEnd="PomodoroTimerEnd_focus",t.FocusAutoplayEnd="PomodoroTimerEnd_focus_autoplay",t.BreakEnd="PomodoroTimerEnd_rest",t.BreakAutoplayEnd="PomodoroTimerEnd_rest_autoplay",t))(L||{});const O=Object.values(L),x={PomodoroTimerEnd_focus:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_focus"!==t)),id:"PomodoroTimerEnd_focus",notification:{title:"ðŸ‘ Nicely done! Time for a break.",message:"Take {{dynamic}} minutes to recharge.\nClick to start break.",buttons:[{title:"â–¶ï¸ Start Break"},{title:"â³ Focus +10min"}],iconUrl:"/img/meta/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_focus_autoplay:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_focus_autoplay"!==t)),id:"PomodoroTimerEnd_focus_autoplay",notification:{title:"ðŸ‘ Nicely done! Time for a break.",message:"Take {{dynamic}} minutes to recharge.\nYour break starts now.",buttons:[{title:"â³ Focus +10min"},{title:"â¸ï¸ Pause Break"}],iconUrl:"/img/meta/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_rest:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_rest"!==t)),id:"PomodoroTimerEnd_rest",notification:{title:"ðŸ§  Resume focus",message:"Try to focus during the next {{dynamic}} minutes. Click to start timer.",buttons:[{title:"â–¶ï¸ Start Focus"},{title:"â³ Break +10min"}],iconUrl:"/img/meta/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_rest_autoplay:{exclusiveWith:O.filter((t=>"PomodoroTimerEnd_rest_autoplay"!==t)),id:"PomodoroTimerEnd_rest_autoplay",notification:{title:"ðŸ§  Focus timer started",message:"Try to focus during the next {{dynamic}} minutes, starting now.",buttons:[{title:"â³ Break +10min"},{title:"â¸ï¸ Pause Focus"}],iconUrl:"/img/meta/icon-128.png",type:"basic",priority:2},type:"pomodoro"}};var U=(t=>(t.StartBreak="startBreak",t.PauseBreak="pauseBreak",t.BreakPlus10="breakPlus10",t.StartFocus="startFocus",t.PauseFocus="pauseFocus",t.FocusPlus10="focusPlus10",t))(U||{});const R={PomodoroTimerEnd_focus:"startBreak",PomodoroTimerEnd_focus_0:"startBreak",PomodoroTimerEnd_focus_1:"focusPlus10",PomodoroTimerEnd_focus_autoplay:"",PomodoroTimerEnd_focus_autoplay_0:"focusPlus10",PomodoroTimerEnd_focus_autoplay_1:"pauseBreak",PomodoroTimerEnd_rest:"startFocus",PomodoroTimerEnd_rest_0:"startFocus",PomodoroTimerEnd_rest_1:"breakPlus10",PomodoroTimerEnd_rest_autoplay:"",PomodoroTimerEnd_rest_autoplay_0:"breakPlus10",PomodoroTimerEnd_rest_autoplay_1:"pauseFocus"},W=(t,e,o,s)=>{if(s)return{mode:A.CountDown,duration:s};let i=10*r;t===D.Focus&&(i=o.focusDuration*r),t===D.Break&&(i=o.restDuration*r);const a=k.currentValue&&e.pomodoroTimerMode||A.Timer;return a===A.CountUp&&(i=Number.POSITIVE_INFINITY),{mode:a,duration:i}},$=5*u,z={permissions:["notifications","alarms"]},q={permissions:["notifications"]};var Y=(t=>(t[t.Play=0]="Play",t[t.Pause=1]="Pause",t))(Y||{});const V=20*r,J=90*r,H=3*n,K="lastInteraction";const G=new class{constructor(){this.state=c("active");const t=t=>{"active"!==t&&"active"===this.state.value&&this.setLastActivityToNow(),this.state.value="locked"===t?"idle":t,l((()=>{"active"===t&&this.setLastActivityToNow()}))};I().then((()=>{setInterval((()=>{d()&&"idle"in d()?d().idle.queryState(300,t):this.setLastActivityToNow()}),30*u),setTimeout((()=>this.setLastActivityToNow()),500)})),d()&&"idle"in d()&&(chrome.idle.setDetectionInterval(300),chrome.idle.onStateChanged.addListener(t))}getMsSinceLastInteraction(){const t=Date.now();return t-Number(localStorage.getItem(K)||t)}setLastActivityToNow(){localStorage.setItem(K,`${Date.now()}`)}},Q=async()=>{const t=G.getMsSinceLastInteraction(),e=Date.now()-t,s=st();return!s.loaded&&s.countUpActive&&s.playing&&t>V&&await s.update({playing:!1,partialProgress:s.partialProgress+(e-s.timeStarted),pausedTimestampFromInactivity:e},!1),s.playing||!s.countUpActive||null===s.pausedTimestampFromInactivity?{}:t<=V?{playing:!0,timeStarted:Date.now(),partialProgress:s.partialProgress+t,pausedTimestampFromInactivity:null}:t<=J?((async()=>{await p((()=>h.tabVisible)).toBe(!0),o.$emit("flashMessage",{message:"Your timer has been paused due to inactivity.",buttons:[{text:"I was focusing",action:()=>{s.update({playing:!0,timeStarted:Date.now(),partialProgress:s.partialProgress+(Date.now()-e)})},dismissOnClick:!0}],closeButtonEnabled:!0,persist:8e3})})(),{pausedTimestampFromInactivity:null}):t<=H?{pausedTimestampFromInactivity:null}:((async()=>{await p((()=>s.loaded)).toBe(!0),await s.complete({switchAfterComplete:!1,dateComplete:new Date(e).toISOString()}),await s.update({pausedTimestampFromInactivity:null})})(),{})},X=(t,e)=>{const o=structuredClone(F[t]);e(o),F[t]=o};const Z=new class{constructor(){this.getterDict={}}get(t,e){const o=this.getterDict[t];if(o)return o.lazyRef.value;const s=c(e()),i=y((()=>e()),((t,e)=>{let o=!1;o="object"==typeof t?JSON.stringify(t)!==JSON.stringify(e):t!==e,o&&(s.value=t)}));return this.getterDict[t]={lazyRef:s,unwatch:i},s.value}delete(t){var e,o;null==(o=null==(e=this.getterDict[t])?void 0:e.unwatch)||o.call(e),t in this.getterDict&&delete this.getterDict.key}},tt=new T({feature:"pomodoro"}),et=M,ot={start:{play:()=>new Audio("sounds/pomo-start.mp3").play()},stop:{play:()=>new Audio("sounds/pomo-stop.mp3").play()},done:{play:()=>new Audio("sounds/pomo-done.mp3").play()}},st=_((({loadedRef:t,updateAsync:e})=>s("pomodoroSession",{state:()=>({playing:!1,timeStarted:0,activeTimerId:D.Focus,partialProgress:0,pausedTimestampFromInactivity:null,countDownTimerLength:null}),getters:{loaded:()=>t.value,activeTimer(){return W(this.activeTimerId,et.focusModeSettings,this.pomodoroSettings,this.countDownTimerLength)},currentProgress(){return this.playing?m.models.date.get("seconds").getTime()-this.timeStarted:0},totalProgress(){return Math.min(this.totalLength,this.currentProgress+this.partialProgress)},totalLength(){return this.activeTimer.duration},timeRemaining(){return Math.max(0,Math.min(this.totalLength,this.totalLength-this.totalProgress))},anyFocusTimerActive(){return!!this.countUpActive||(!!this.countDownActive||[D.Focus,D.FocusPlusTen].includes(this.activeTimerId))},anyBreakTimerActive(){return!this.countUpActive&&(!this.countDownActive&&[D.Break,D.BreakPlusTen].includes(this.activeTimerId))},countUpActive(){return this.activeTimer.mode===A.CountUp},countDownActive(){return this.activeTimer.mode===A.CountDown},pomodoroSettings:()=>et.pomodoroSettings,focusedMinutes(){return Z.get("focusedMinutes",(()=>this.anyFocusTimerActive?Math.floor(this.totalProgress/r):0))},timeToDisplay(){return this.countUpActive?this.totalProgress:this.timeRemaining},hours(){return parseInt(Math.floor(this.timeToDisplay/n).toFixed(0))},minutes(){const t=(Math.floor(this.timeToDisplay/r)%60).toFixed(0);return(this.countUpActive||this.countDownActive)&&0===this.hours||this.pomodoroSettings.hideSeconds?t:v(t)},seconds(){return v((Math.floor(this.timeToDisplay/u)%60).toFixed(0))},fullTimeString(){return this.pomodoroSettings.hideSeconds?`${0!==this.hours?this.hours+"h ":""} ${this.minutes}m`:`${0!==this.hours?this.hours+":":""}${this.minutes}:${this.seconds}`}},actions:{async update(t,o){await e(t,o)},resume({playSounds:t=!1}={}){if(!this.playing)return this.pomodoroSettings.sounds&&t&&ot.start.play(),this.syncPendingNotification(),this.update({playing:!0,timeStarted:m.models.date.get("seconds").getTime()})},pause({playSounds:t=!1}={}){if(this.playing)return this.pomodoroSettings.sounds&&t&&ot.stop.play(),this.deleteNotification(),this.update({playing:!1,partialProgress:this.partialProgress+this.currentProgress})},async complete({switchAfterComplete:t=!0,completedManually:e=!1,switchToTimer:o,dateComplete:s=(new Date).toISOString(),playSounds:i=!0}={}){this.pomodoroSettings.sounds&&i&&this.totalProgress>0&&ot.done.play();let a=this.activeTimerId;o?a=o:t&&(a=this.anyFocusTimerActive?D.Break:D.Focus,this.pomodoroSettings.autoplay&&g(500).then((()=>{this.resume({playSounds:!1})})));const r=this.focusedMinutes;if(await this.update({playing:!1,partialProgress:0,activeTimerId:a}),r){const t=nt();t.refresh(),await p((()=>t.loaded)).toBe(!0);const e={focusMinutes:r,dateCreated:s,completed:s,aggregatedEntries:1,manualAdjustment:!1};0===t.data.length&&m.trigger("pomodoro:firstSessionCompleted"),await t.create(e),tt.capture("pomodoro complete",{period:this.activeTimerId,focusMinutes:r})}e&&await this.deleteNotification()},async switchTo(t,{startPlaying:e=!0,playSounds:o=!1}={}){this.activeTimerId!==t?(this.playing||0!==this.totalProgress?await this.complete({completedManually:!0,switchToTimer:t}):await this.update({activeTimerId:t}),e&&(await g(500),await this.resume({playSounds:o}))):e&&!this.playing&&await this.resume({playSounds:o})},async restartTimer(){const t=this.playing;await this.complete({switchAfterComplete:!1,completedManually:!0}),t&&await this.resume()},async deleteNotification(){await i.sendMessage({handler:"deleteNotification",args:[O],timeout:4e4})},async syncPendingNotification(t=!1){if(this.pomodoroSettings.browserNotifications){const e=t?this.anyFocusTimerActive?L.FocusAutoplayEnd:L.BreakAutoplayEnd:this.anyFocusTimerActive?L.FocusEnd:L.BreakEnd,o=W(this.anyFocusTimerActive?D.Break:D.Focus,et.focusModeSettings,this.pomodoroSettings,this.countDownTimerLength).duration/r,s={...structuredClone(x[e]),time:Date.now()+this.timeRemaining};s.notification.message=s.notification.message.replace("{{dynamic}}",`${o}`),f()&&delete s.notification.buttons,await i.sendMessage({handler:"createOrUpdateNotification",args:[s],timeout:4e4})}else await i.sendMessage({handler:"deleteNotificationsOfType",args:["pomodoro"]})},async onNotificationClick(t){switch(R[t]){case U.StartBreak:await this.switchTo(D.Break);break;case U.PauseBreak:this.playing&&this.anyBreakTimerActive&&await this.pause();break;case U.BreakPlus10:await this.switchTo(D.BreakPlusTen);break;case U.StartFocus:await this.switchTo(D.Focus);break;case U.PauseFocus:this.playing&&this.anyFocusTimerActive&&await this.pause();break;case U.FocusPlus10:await this.switchTo(D.FocusPlusTen)}},async ensureNotificationPermissions(){const t=await this.getNotificationsPermissionsToRequest(),e=!t||await B(t,{source:"Pomodoro",reason:"To show browser notifications"});this.saveSettingsToCustomization("browserNotifications",e)},async getNotificationsPermissionsToRequest(){const t=f()?q:z;return await b.permissions.contains(t)?null:t},saveSettingsToCustomization(t,e){X("pomodoroSettings",(o=>{o[t]=e})),this.playing&&this.syncPendingNotification()}}})),{mode:e.Cache,syncAutomatically:!0,fixStateBeforeLoad:async()=>await Q()}),it=new E("pomodoro-running",!1);(async()=>{const t=st();await p((()=>t.loaded)).toBe(!0),it.switchOverToWatchedStoreItem((()=>t.playing))})(),y(G.state,(async t=>{const e=st();"active"===t?await e.update(await Q()):(await p((()=>e.loaded)).toBe(!0),e.playing&&e.countUpActive&&(await e.pause(),await e.update({pausedTimestampFromInactivity:Date.now()})))}));const at=Object.freeze(Object.defineProperty({__proto__:null,default:st,usePomodoroSessionStore:st},Symbol.toStringTag,{value:"Module"})),rt=(o=(()=>({pomodoroCompletedService:new C(new t("pomodoro",{path:"pomodoro/completed",mode:e.Timestamp,getResponseProperty:"completed"}))}))().pomodoroCompletedService)=>s("pomodoroCompleted",{state:()=>({data:[],loading:!1,loaded:!1}),getters:{currentSessionLength(){const t=st();return t.pausedTimestampFromInactivity?0:t.focusedMinutes},dataWithCurrentSessionIfActive(t){const e=[...t.data];return this.currentSessionLength>0&&e.push({id:P(),completed:(new Date).toISOString(),focusMinutes:this.currentSessionLength,aggregatedEntries:1,manualAdjustment:!1}),e},completedStatsDaily(){return t=>{const e=Array(t+1).fill(void 0).map(((t,e)=>a.getDateStringDayOffset(-1*e))).map((t=>this.dataWithCurrentSessionIfActive.filter((e=>((t,e)=>t&&t.completed&&e.includes(a.getDateString(t.completed)))(e,[t])))));return{counts:e.map(N),focusedMinutes:e.map(j)}}},completedStats(){const t=this.completedStatsDaily(0),e=this.completedStatsDaily(m.models.date.get("hour").getDay());return{counts:{today:a.sumArray(t.counts),week:a.sumArray(e.counts),allTime:N(this.dataWithCurrentSessionIfActive)},focusedMinutes:{today:a.sumArray(t.focusedMinutes),week:a.sumArray(e.focusedMinutes),allTime:j(this.dataWithCurrentSessionIfActive)}}},allTimeMinutes(){return this.completedStats.focusedMinutes.allTime},weekMinutes(){return this.completedStats.focusedMinutes.week},todayMinutes(){return this.completedStats.focusedMinutes.today},pastDaysMinutes(){return t=>a.sumArray(this.completedStatsDaily(t).focusedMinutes)},allTime(){return w(60*this.allTimeMinutes*1e3)},week(){return w(60*this.weekMinutes*1e3)},today(){return w(60*this.todayMinutes*1e3)},completedCountSince(){return t=>this.dataWithCurrentSessionIfActive.filter((e=>new Date(e.completed).getTime()>t&&!e.manualAdjustment)).length},pastDays(){return t=>w(60*this.pastDaysMinutes(t)*1e3)}},actions:{refresh({daysNeeded:t=32}={}){let s=!1;const i=this.data.find((t=>t.aggregatedEntries>1));if(i){S(new Date(i.completed),new Date,0)<t&&(s=!0)}(s||!this.loaded&&!this.loading)&&(this.loading=!0,o.get({success:t=>{this.data=t||[],this.loaded=!0,this.loading=!1},queryParams:{cutoffDays:`${t}`},mode:s?e.Server:e.Timestamp}))},async create(t){const e={...t,id:a.uuidv4()};this.data.splice(this.data.length,0,e),await o.create(e)},async update(t,e){const s=this.data.findIndex((e=>e.id===t)),i=this.data[s];if(!i)throw new Error(`No data found for ${t}`);const a={...i,...e};return this.data.splice(s,1,a),await o.update(t,e),a}}}),nt=rt(),ut=Object.freeze(Object.defineProperty({__proto__:null,default:nt,makePomodoroCompletedStore:rt,usePomodoroCompletedStore:nt},Symbol.toStringTag,{value:"Module"}));export{Y as P,$ as T,nt as a,at as b,ut as c,Z as l,X as m,R as p,N as s,st as u};