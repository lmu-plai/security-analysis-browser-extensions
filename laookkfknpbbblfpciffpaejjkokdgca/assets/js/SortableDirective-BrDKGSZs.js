import{a4 as e,C as t,x as i,I as r,r as s,w as n,y as a,az as l,n as o}from"./index-B9SbLlJ5.js";import{B as g,a as d}from"./BaseItemList-kFdAe94b.js";import{e as h}from"./links-BiNnZQ-c.js";import{d as c}from"./index-CbkRD371.js";import{u as v}from"./Logger-BTKFyPnc.js";import{n as u}from"./_plugin-vue2_normalizer-DeUNqxFl.js";const p=(r,s)=>{const n={dynamic:e([]),original:[],internal:[]},a=e=>{const t=e.map((e=>({id:`${e.id}-${s.type}`,type:s.type,group:s.group,restrictToGroup:!!s.restrictToGroup,useHandle:!!s.useHandles,reactive:!!s.reactive,data:e})));n.original=t,n.dynamic.value=[...t],n.internal=[...t]},l=t(r,a);return h.sortableLists[s.group]={managedLists:n,type:s.type,reset:()=>{a(r.value)}},i((()=>{l(),delete h.sortableLists[s.group]})),n.dynamic};const m=u(r({name:"SortableItemList",components:{BaseItemList:g},props:{...d,items:{type:Array,required:!0},type:{type:String,required:!0},group:{type:String,default:()=>v()},useHandles:{type:Boolean,default:!1},reactive:{type:Boolean,default:!1}},setup(e){const t=s(),{isOutside:i}=c(t);return n((()=>i.value),(t=>{if(!t)return;const i=Object.values(h.sortables).find((e=>e.draggable.active));i&&i.group===e.group&&Object.values(h.sortableLists).forEach((t=>{t.type===e.type&&t.reset()}))})),{itemList:t,list:p(a((()=>e.items)),{group:e.group,type:e.type,useHandles:e.useHandles,reactive:e.reactive})}}}),(function(){var e=this,t=e._self._c;return e._self._setupProxy,t("base-item-list",e._b({ref:"itemList",staticClass:"sortable-item-list"},"base-item-list",e.$props,!1),[e._t("default",null,{sortables:e.list})],2)}),[],!1,null,"1cc255e3").exports;class b{constructor({el:e,id:t,type:i,reactive:r,useHandle:s}){this.draggingScrollThreshold=100,this.draggingScrollMaxSpeed=10,this.initiateDragging=e=>{document.addEventListener("touchmove",this.stopInitiateDragging,{capture:!0,passive:!1}),this.draggingInitiatorTimeout=setTimeout((()=>{if(this.removeInitiateListeners(),this.useHandle){const t=this.el.querySelector("[data-drag-drop-handle]");if(!t||e.target!==t&&!t.contains(e.target))return void this.stopInitiateDragging()}this.dragging=!0,h.activeDraggable=this,document.addEventListener("pointermove",this.trackMoveThrottled,{capture:!0,passive:!1}),document.addEventListener("touchmove",this.trackMoveThrottled,{capture:!0,passive:!1}),document.addEventListener("pointerup",this.stopDragging),document.addEventListener("touchend",this.stopDragging),document.addEventListener("click",this.destroyEvent,{capture:!0}),document.addEventListener("contextmenu",this.destroyEvent,{capture:!0});const{x:t,y:i}=this.getEventXY(e),{left:r,top:s}=this.el.getBoundingClientRect();this.draggingXOffset=t-r,this.draggingYOffset=i-s,Object.values(h.droppables).forEach((e=>{e.type===this.type&&e.onDraggableActive()})),this.updateElementDraggingState(),this.createDraggingElement(),this.createElementContentWatcher(),this.trackMove(e),this.setScrollingContainer(e)}),l()&&!this.useHandle?500:300)},this.stopInitiateDragging=()=>{this.removeInitiateListeners(),clearTimeout(this.draggingInitiatorTimeout)},this.removeInitiateListeners=()=>{document.removeEventListener("touchmove",this.stopInitiateDragging,{capture:!0})},this.destroyEvent=e=>{e.cancelable&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation())},this.stopDragging=()=>{this.resetDraggingState(),this.eventListeners.drop.frame&&cancelAnimationFrame(this.eventListeners.drop.frame),this.eventListeners.drop.frame=requestAnimationFrame((()=>{const e=Object.values(h.droppables).find((e=>e.active));this.eventListeners.drop.listeners.forEach((t=>t(e??null)))})),Object.values(h.droppables).forEach((e=>{e.onDraggableDrop()})),setTimeout((()=>{document.removeEventListener("click",this.destroyEvent,{capture:!0}),document.removeEventListener("contextmenu",this.destroyEvent,{capture:!0})}),100)},this.trackMoveThrottled=e=>{e.cancelable&&e.preventDefault(),this.draggingMoveThrottle||(this.draggingMoveThrottle=setTimeout((()=>{requestAnimationFrame((()=>{this.draggingMoveThrottle=void 0,this.trackMove(e)}))}),l()?10:5))},this.el=e,this.id=t,this.type=i,this.reactive=r,this.useHandle=s??!1,this.dragging=!1,this.draggingXOffset=0,this.draggingYOffset=0,this.eventListeners={drop:{listeners:new Set([]),frame:void 0},over:{listeners:new Set([]),frame:void 0}},this.addPointerEventListeners()}createDraggingElement(){var e,t,i;const r=this.el.getBoundingClientRect(),s=this.el.cloneNode(!0);s.setAttribute("id","dragging-el"),s.setAttribute("data-draggable-dragging",""),s.removeAttribute("data-draggable-drag-parent"),s.style.width=r.width+"px",s.style.height=r.height+"px",s.style.willChange="translate",l()&&(this.draggingEl?s.style.scale="1.15":(s.style.transition="scale 0.2s ease-in-out",setTimeout((()=>{s.style.scale="1.15"}),50)));const n=null==(e=this.draggingEl)?void 0:e.style.translate;n&&(s.style.translate=n),null==(t=this.draggingEl)||t.remove(),null==(i=document.querySelector("#drag-drop-portal"))||i.insertAdjacentElement("beforeend",s),this.draggingEl=s}createElementContentWatcher(){var e;this.reactive&&(null==(e=this.draggingElObserver)||e.disconnect(),this.draggingElObserver=new MutationObserver((()=>this.createDraggingElement())),this.draggingElObserver.observe(this.el,{subtree:!0,childList:!0,characterData:!0}))}updateElementDraggingState(){this.el.setAttribute("data-draggable-drag-parent","")}updateElementState(){this.el.style["-webkit-touch-callout"]="none",this.el.style.webkitUserSelect="none"}getEventXY(e){var t,i,r,s;let n,a;return"touches"in e?(n=(null==(t=e.touches[0])?void 0:t.clientX)??(null==(i=e.changedTouches[0])?void 0:i.clientX)??0,a=(null==(r=e.touches[0])?void 0:r.clientY)??(null==(s=e.changedTouches[0])?void 0:s.clientY)??0):(n=e.clientX,a=e.clientY),{x:n,y:a}}trackMove(e){const{x:t,y:i}=this.getEventXY(e);this.draggingEl&&(this.draggingEl.style.translate=`${t-this.draggingXOffset}px ${i-this.draggingYOffset}px 0px`),l()&&Object.values(h.droppables).forEach((e=>{e.type===this.type&&e.handleBoundsXY(t,i)})),this.setScrollContainerScrollInterval(t,i),clearTimeout(this.draggingScrollTimeout),this.draggingScrollTimeout=setTimeout((()=>{this.draggingScrollingFrame&&cancelAnimationFrame(this.draggingScrollingFrame),this.draggingScrollingFrame=requestAnimationFrame((()=>this.setScrollingContainer(e)))}),300)}isElementOverflowing(e){const t=getComputedStyle(e),i="auto"===t.overflowX||"scroll"===t.overflowX,r="auto"===t.overflowY||"scroll"===t.overflowY,s=i&&e.scrollWidth>e.clientWidth+1,n=r&&e.scrollHeight>e.clientHeight+1;return s||n?[e,s,n]:[null,!1,!1]}setScrollingContainer(e){var t;const{x:i,y:r}=this.getEventXY(e),s=document.elementsFromPoint(i,r);let n=null,a=!1,l=!1;s.some((e=>{const t=this.isElementOverflowing(e);return!!t[0]&&(n=t[0],a=t[1],l=t[2],!0)})),n&&(null==(t=this.draggingScrollContainer)?void 0:t.el)!==n&&(this.resetScrollingContainer(),this.draggingScrollContainer={el:n,x:a,y:l,rect:n.getBoundingClientRect()},this.setScrollContainerScrollInterval(i,r))}resetScrollingContainer(){this.draggingScrollContainer&&(this.draggingScrollContainer=void 0)}calculateScrollSpeed(e){const t=1-Math.max(0,Math.min(e,this.draggingScrollThreshold))/this.draggingScrollThreshold;return this.draggingScrollMaxSpeed*Math.pow(t,5+t)}setScrollContainerScrollInterval(e,t){if(!this.draggingScrollContainer)return;const{el:i,x:r,y:s,rect:{left:n,right:a,top:l,bottom:o}}=this.draggingScrollContainer;let g=0,d=0;r&&e<n+this.draggingScrollThreshold&&(g=-this.calculateScrollSpeed(e-n)),r&&e>a-this.draggingScrollThreshold&&(g=this.calculateScrollSpeed(a-e)),s&&t<l+this.draggingScrollThreshold&&(d=-this.calculateScrollSpeed(t-l)),s&&t>o-this.draggingScrollThreshold&&(d=this.calculateScrollSpeed(o-t));const h=t>l&&t<o&&!!g,c=e>n&&e<a&&!!d;clearInterval(this.draggingScrollContainerInterval),(h||c)&&(this.draggingScrollContainerInterval=setInterval((()=>{i.scrollBy(g,d)}),5))}resetDraggingState(){var e,t;document.removeEventListener("pointermove",this.trackMoveThrottled,{capture:!0}),document.removeEventListener("touchmove",this.trackMoveThrottled,{capture:!0}),document.removeEventListener("pointerup",this.stopDragging),document.removeEventListener("touchend",this.stopDragging),clearTimeout(this.draggingMoveThrottle),this.draggingMoveThrottle=void 0,clearTimeout(this.draggingScrollTimeout),this.draggingScrollingFrame&&cancelAnimationFrame(this.draggingScrollingFrame),this.draggingScrollTimeout=void 0,clearInterval(this.draggingScrollContainerInterval),this.resetScrollingContainer(),null==(e=this.draggingElObserver)||e.disconnect(),null==(t=this.draggingEl)||t.remove(),this.el.removeAttribute("data-draggable-drag-parent"),this.dragging=!1,h.activeDraggable=null}addPointerEventListeners(){this.el.addEventListener("pointerdown",this.initiateDragging),this.el.addEventListener("pointerup",this.stopInitiateDragging)}removePointerEventListeners(){this.el.removeEventListener("pointerdown",this.initiateDragging),this.el.removeEventListener("pointerup",this.stopInitiateDragging)}get active(){return this.dragging}get element(){return this.el}triggerOverEvents(e){this.eventListeners.over.frame&&cancelAnimationFrame(this.eventListeners.over.frame),this.eventListeners.over.frame=requestAnimationFrame((()=>{this.eventListeners.over.listeners.forEach((t=>t(e)))}))}updateState(e){if(this.el===e)return this.updateElementState(),void(this.dragging&&this.updateElementDraggingState());this.removePointerEventListeners(),this.el=e,this.addPointerEventListeners(),o().then((()=>{this.updateElementState(),this.dragging&&(this.updateElementDraggingState(),this.createDraggingElement(),this.createElementContentWatcher())}))}addEventListener(e,t){this.eventListeners[e].listeners.add(t)}removeEventListener(e,t){this.eventListeners[e].listeners.delete(t)}destroy(){this.removePointerEventListeners(),this.resetDraggingState()}}class E{constructor({el:e,id:t,type:i,data:r}){var s;this.handleBoundsEnter=()=>{var e;this.draggableOver||(this.draggableOver=!0,this.updateElementOver(),null==(e=h.activeDraggable)||e.triggerOverEvents(this))},this.handleBoundsLeave=()=>{this.draggableOver&&(this.draggableOver=!1,this.el.removeAttribute("data-droppable-drag-over"))},this.el=e,this.id=t,this.type=i,this.data=r??{},this.draggableOver=!1,this.draggableActive=!1,(null==(s=h.activeDraggable)?void 0:s.type)===this.type&&this.onDraggableActive()}updateElementActive(){this.el.setAttribute("data-droppable-drop-active","")}updateElementOver(){this.el.setAttribute("data-droppable-drag-over","")}get active(){return this.draggableActive}get element(){return this.el}handleBoundsXY(e,t){const i=this.el.getBoundingClientRect();e>=i.left&&e<=i.right&&t>=i.top&&t<=i.bottom?this.handleBoundsEnter():this.handleBoundsLeave()}onDraggableActive(){this.draggableActive||(this.draggableActive=!0,this.addPointerEventListeners(),this.updateElementActive())}onDraggableDrop(){this.draggableActive=!1,this.draggableOver=!1,this.el.removeAttribute("data-droppable-drop-active"),this.el.removeAttribute("data-droppable-drag-over"),this.removePointerEventListeners()}addPointerEventListeners(){this.el.addEventListener("pointerenter",this.handleBoundsEnter),this.el.addEventListener("pointerleave",this.handleBoundsLeave)}removePointerEventListeners(){this.el.removeEventListener("pointerenter",this.handleBoundsEnter),this.el.removeEventListener("pointerleave",this.handleBoundsLeave)}updateState(e){this.el!==e&&(this.removePointerEventListeners(),this.el=e),o().then((()=>{this.draggableActive&&this.updateElementActive(),this.draggableOver&&this.updateElementOver()}))}destroy(){this.onDraggableDrop()}}class L{constructor({el:e,id:t,type:i,group:r,useHandle:s,reactive:n}){this.insertDraggingAfterDroppable=e=>{const t=h.sortables[e.id];if(!t||t.id===this.id)return;if(t.el.classList.contains("v-move"))return;const i=h.sortableLists[this.group],r=[...(null==i?void 0:i.managedLists.internal)??[]],s=null==r?void 0:r.findIndex((e=>e.id===this.id));if(!i)return;const n=h.sortableLists[t.group],a=i===n?r:[...(null==n?void 0:n.managedLists.internal)??[]],l=null==a?void 0:a.findIndex((e=>e.id===t.id));if(!n||-1===l)return;const[o]=r.splice(s,1);o&&(a.splice(l,0,o),this.group=t.group,o.group=t.group,i.managedLists.internal=r,n.managedLists.internal=a,clearTimeout(this.insertAfterBatchTimeout),this.insertAfterBatchTimeout=setTimeout((()=>{requestAnimationFrame((()=>{i.managedLists.dynamic.value=i.managedLists.internal,n.managedLists.dynamic.value=n.managedLists.internal}))}),5))},this.confirmDrop=()=>{var e,t;const i=h.sortableLists[this.group],r=null==i?void 0:i.managedLists.internal,s=null==(e=null==r?void 0:r.find((e=>e.id===this.id)))?void 0:e.data,n=null==r?void 0:r.map((e=>e.data)),a=null==i?void 0:i.managedLists.original,l=null==r?void 0:r.some(((e,t)=>{var i;return e.id!==(null==(i=null==a?void 0:a[t])?void 0:i.id)}));if(s&&n&&l){const e=n.indexOf(s);null==(t=h.sortableCallbacks[this.type])||t.forEach((t=>{t({itemMoved:s,newOrder:n,newIndex:e,group:this.group,prevItem:n[e-1]??null,nextItem:n[e+1]??null})}))}},this.id=t,this.el=e,this.group=r,this.type=i,this.draggable=new b({el:e,id:t,type:i,useHandle:s,reactive:n}),this.droppable=new E({el:e,id:t,type:i}),h.draggables[t]=this.draggable,h.droppables[t]=this.droppable,this.addDraggableEventListeners()}addDraggableEventListeners(){this.draggable.addEventListener("over",this.insertDraggingAfterDroppable),this.draggable.addEventListener("drop",this.confirmDrop)}removeDraggableEventListeners(){this.draggable.removeEventListener("over",this.insertDraggingAfterDroppable),this.draggable.removeEventListener("drop",this.confirmDrop)}get element(){return this.el}updateState(e,t){this.el=e,this.group=t,this.draggable.updateState(e),this.droppable.updateState(e)}destroy(){this.removeDraggableEventListeners(),this.draggable.destroy(),this.droppable.destroy(),delete h.draggables[this.id],delete h.droppables[this.id]}}const S={bind:(e,{value:{id:t,type:i,group:r,useHandle:s,reactive:n}})=>{let a=h.sortables[t];a||(a=new L({el:e,id:t,type:i,group:r,useHandle:s,reactive:n})),a.updateState(e,r),h.sortables[a.id]=a},componentUpdated:(e,{value:{id:t,group:i}})=>{var r;null==(r=h.sortables[t])||r.updateState(e,i)},unbind:(e,{value:{id:t}})=>{const i=h.sortables[t];i&&i.element===e&&!i.draggable.active&&(i.destroy(),delete h.sortables[i.id])}};export{m as S,S as a};