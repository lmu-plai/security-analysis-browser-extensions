import{d as e,M as t}from"./DataSyncService-BIQVYvDv.js";import{E as i,M as a,a as r,p as s}from"./errors-CZrPVA9A.js";import{e as n,f as l,L as o,a9 as d,aa as h,ab as u,V as c,u as p,C as v}from"./index-B9SbLlJ5.js";import{u as g,a as y}from"./Logger-BTKFyPnc.js";import{B as w}from"./BaseMetric-ClLQP9bU.js";import{c as f}from"./compareObjects-R6Hcs7xe.js";import{computed as I}from"./reactiveCustomization-l1DAJU8W.js";import{P as T}from"./pinia-4ulFHh2N.js";var D=(e=>(e.Never="none",e.Daily="daily",e.Weekly="weekly",e.Monthly="monthly",e.Yearly="yearly",e))(D||{}),S=(e=>(e.Manual="manual",e.Url="url",e.Integration="integration",e))(S||{});class M{constructor({id:e=g(),label:t="",value:i="",pinned:a=!1,archived:r=!1,rounding:s=null,random:n=!1,cycle:l="none",isTeam:o=!1,path:d=null,providerDataPointId:h=null,externalUrl:m=null,providerId:u=null,url:c=null,unit:p=null,readOnly:v=!1,icon:y,modifiedServer:w=(new Date).toISOString(),metricType:f}){this.id=e,this.label=t,this.value=i,this.rounding=s,this.cycle=l,this.path=d,this.providerDataPointId=h,this.externalUrl=m,this.providerId=u,this.url=c,this.unit=p,this.pinned=a,this.random=n,this.isTeam=o,this.readOnly=v,this.archived=r,this.icon=y??"goal",this.modifiedServer=w,this.metricType=f||(this.url?"url":this.providerId?"integration":"manual"),this.resetValueIfCycleElapsed()}compare(e){return f((null==e?void 0:e.serialize())??new M({id:this.id,modifiedServer:this.modifiedServer,metricType:this.metricType}).serialize(),this.serialize())}validate(){if("integration"===this.metricType&&null===this.providerId)throw new o({message:i.ProviderEmpty});if("integration"===this.metricType&&null===this.providerDataPointId)throw new o({message:i.ProviderValueInvalid,input:"value"});if(""===this.name)throw new o({message:i.NameEmpty,input:"name"});if(this.name.length>a)throw new o({message:i.NameTooLong,input:"name"});if("manual"===this.metricType&&""===this.value)throw new o({message:i.ValueEmpty,input:"value"});if("url"===this.metricType&&!this.url)throw new o({message:i.UrlEmpty,input:"url"});if("url"===this.metricType&&this.url&&!d(h(this.url)))throw new o({message:i.UrlInvalid,input:"url"});if("url"===this.metricType&&this.url&&this.url.length>r)throw new o({message:i.UrlTooLong,input:"url"})}serialize(){const e={...this};return delete e.metricType,e}get type(){return w.Metric}resetValueIfCycleElapsed(){"manual"===this.metricType&&this.cycle&&"none"!==this.cycle&&(e=>{const t=n().split(/\D/);if(!t[0]||!t[1]||!t[2])return new Date(0);const i=new Date(+t[0],+t[1]-1,+t[2]);i.setHours(l.dateRolloverHour);const a=new Date(i.getTime());if(e===D.Daily)return a;const r=new Date(i.getTime());if(r.setDate(r.getDate()-(r.getDay()+6)%7),e===D.Weekly)return r;const s=new Date(i.getTime());if(s.setDate(1),e===D.Monthly)return s;const o=new Date(i.getTime());return o.setDate(1),o.setMonth(0),e===D.Yearly?o:new Date(0)})(this.cycle).getTime()>new Date(this.modifiedServer).getTime()&&(u(this.value)?this.value="0":this.value="")}get name(){return this.label}set name(e){this.label=e}get displayTooltip(){return this.authNeeded?"Authorization Needed":this.externalUrl||""}get displayValue(){return"url"===this.metricType&&u(this.rounding)&&u(this.value)?Number(this.value).toFixed(this.rounding):this.authNeeded||""===this.value||null===this.value||void 0===this.value?"-":`${this.value+(this.unit??"")}`}get authNeeded(){return"integration"===this.metricType&&"Authorization needed."===this.value}get disableSave(){return!("integration"!==this.metricType||this.providerId&&this.providerDataPointId)}get shouldDisplayQuickAdjust(){return"manual"===this.metricType&&!this.isTeam&&!this.readOnly&&u(this.value)}}const b=((i=s().metricsService)=>{let a;const r=e("metrics",{plugins:[T.MockData],state:()=>({data:{},loading:!1,loaded:!1,activeItem:null,randomItems:[],selectedProviderId:""}),getters:{items:e=>Object.values(e.data).filter((e=>!e.archived)).map((e=>new M(e))).sort(((e,t)=>+t.pinned-+e.pinned)),unpinnedItems:e=>Object.values(e.data).filter((e=>!e.archived&&!e.pinned)).map((e=>new M(e))),pinnedItems:e=>Object.values(e.data).filter((e=>!e.archived&&e.pinned)).map((e=>new M(e))),archivedItems:e=>Object.values(e.data).filter((e=>e.archived)).map((e=>new M(e))),getItemById(e){const t=e.data;return e=>{const i=t[e];if(i)return new M(i)}},showRandom(){return 0===this.pinnedItems.length||!!I["showRandomMetric-metric"]}},actions:{clearActiveItem(){this.activeItem=null},setRandomItems(){!this.showRandom||this.unpinnedItems.length<=0?this.randomItems=[]:this.randomItems=[y(this.unpinnedItems)]},newItem(e=S.Manual){this.activeItem||(this.activeItem=new M({metricType:e}))},editItem(e){const t=this.data[e];if(!t)throw new o({message:`No metric found with id: ${e}`});this.activeItem=new M(t)},refresh(e){!(null==e?void 0:e.force)&&(this.loading||this.loaded&&!(null==e?void 0:e.archived))||(this.loading=!0,i.get({success:e=>{this.data=Object.fromEntries(e.map((e=>[e.id,e]))),this.loaded=!0,this.loading=!1},failure:()=>{this.loading=!1},...(null==e?void 0:e.archived)&&{queryParams:{includeArchived:"true"},mode:t.Server}}))},async create(e){c.set(this.data,e.id,e),await i.create(e)},async update(e,t){const a=this.data[e];if(!a)throw new o({message:`No metric found with id: ${e}`});c.set(this.data,e,{...a,...t,modifiedServer:(new Date).toISOString()}),await i.update(e,t)},async delete(e){c.delete(this.data,e),await i.delete(e)},async openItemOnTeamSite(e){let t=await i.getMetricServerId(e);t.toUpperCase().startsWith("T")&&(t=t.substring(1)),m.commandManager.execute("window.account.open.login",`/team/metrics?id=${t}`)},getMetricUrlValues:async e=>(await i.getMetricUrlValues(h(e))).data.values,startMetricUpdateInterval(){const e=3e5,t=async()=>{const r=Number(localStorage.getItem("metrics:lastRefreshed")),s=(new Date).getTime();if(isNaN(r)||s-r>=e){localStorage.setItem("metrics:lastRefreshed",String(s)),clearTimeout(a);try{await i.refresh(),a=setTimeout((()=>{t()}),e)}catch(n){a=void 0,console.error(n)}}};clearTimeout(a),a=setTimeout((()=>{t()}),e)},stopMetricUpdateInterval(){clearTimeout(a)}}});return(async()=>{const e=r();await p((()=>e.loaded)).toBe(!0),v((()=>e.showRandom),(()=>{e.setRandomItems()})),v((()=>I.metricVisible),(t=>{t?e.startMetricUpdateInterval():e.stopMetricUpdateInterval()}))})(),r})(),j=Object.freeze(Object.defineProperty({__proto__:null,default:b,useMetricsStore:b},Symbol.toStringTag,{value:"Module"}));export{M,S as a,D as b,j as m,b as u};